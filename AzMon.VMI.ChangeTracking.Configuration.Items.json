{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "LogAnalyticsWorkspaceId": {
            "defaultValue": "",
            "type": "String"
        },
        "Location": {
            "defaultValue": "",
            "type": "String"
        },
        "resourceGroupName": {
            "defaultValue": "",
            "type": "String"
        },
        "ALERT_INCLUDE_FILTER_RESOURCE_ID": {
            "defaultValue": "",
            "type": "String"
        },
        "ALERT_EXCLUDE_FILTER_RESOURCE_ID": {
            "defaultValue": "RESOURCE ID EXCLUSION STRING",
            "type": "String"
        },
        "ALERT_INCLUDE_FILTER_SERVERNAME": {
            "defaultValue": "",
            "type": "String"
        },
        "workbookId": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "The unique guid for this workbook instance"
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "nestedDataCollectionDeployment",
            "resourceGroup": "[parameters('resourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [
                        {
                          "type": "microsoft.insights/scheduledqueryrules",
                          "apiVersion": "2021-08-01",
                          "name": "Windows Server - Essential Service Stopped",
                          "Location": "[parameters('Location')]",
                          "properties": {
                            "displayName": "Windows Server - Essential Service Stopped",
                            "description": "An essential Windows Server service has stopped",
                            "severity": 1,
                            "enabled": true,
                            "evaluationFrequency": "PT5M",
                            "scopes": [
                              "[parameters('LogAnalyticsWorkspaceId')]"
                            ],
                            "targetResourceTypes": [
                              "Microsoft.OperationalInsights/workspaces"
                            ],
                            "windowSize": "P2D",
                            "criteria": {
                              "allOf": [
                                {
                                  "query": "[concat('ConfigurationData\n| where Computer contains \"',parameters('ALERT_INCLUDE_FILTER_SERVERNAME'),'\"\n| where _ResourceId contains \"',parameters('ALERT_INCLUDE_FILTER_RESOURCE_ID'),'\"\n| where _ResourceId !contains \"',parameters('ALERT_EXCLUDE_FILTER_RESOURCE_ID'),'\"\n| where ConfigDataType == \"WindowsServices\"\n| where SvcStartupType == \"Auto\"\n| where SvcName in \n(\"Dhcp\",\n\"Dnscache\",\n\"PlugPlay\",\n\"RpcSs\",\n\"LanmanServer\",\n\"lmhosts\",\n\"EventLog\",\n\"mpssvc\",\n\"WinRM\",\n\"LanmanWorkstation\")\n| extend State = iif(SvcState == \"Running\",1,0)\n| summarize arg_max(TimeGenerated,State,SvcState) by Computer,SvcDisplayName, _ResourceId\n')]",
                                  "timeAggregation": "Total",
                                  "metricMeasureColumn": "State",
                                  "dimensions": [
                                    {
                                      "name": "SvcDisplayName",
                                      "operator": "Include",
                                      "values": [
                                        "*"
                                      ]
                                    },
                                    {
                                      "name": "SvcState",
                                      "operator": "Include",
                                      "values": [
                                        "*"
                                      ]
                                    }
                                  ],
                                  "resourceIdColumn": "_ResourceId",
                                  "operator": "Equal",
                                  "threshold": 0,
                                  "failingPeriods": {
                                    "numberOfEvaluationPeriods": 1,
                                    "minFailingPeriodsToAlert": 1
                                  }
                                }
                              ]
                            },
                            "autoMitigate": true
                          }
                        },
                        {
                          "type": "microsoft.insights/scheduledqueryrules",
                          "apiVersion": "2022-06-15",
                          "name": "VM Performance - High CPU",
                          "Location": "[parameters('Location')]",
                          "properties": {
                            "displayName": "VM Performance - High CPU",
                            "description": "CPU is over 95% for 30 minutes",
                            "severity": 2,
                            "enabled": true,
                            "evaluationFrequency": "PT10M",
                            "scopes": [
                              "[parameters('LogAnalyticsWorkspaceId')]"
                            ],
                            "targetResourceTypes": [
                              "Microsoft.OperationalInsights/workspaces"
                            ],
                            "windowSize": "PT5M",
                            "criteria": {
                              "allOf": [
                                {
                                  "query": "[concat('InsightsMetrics\n| where Computer contains \"',parameters('ALERT_INCLUDE_FILTER_SERVERNAME'),'\"\n| where _ResourceId contains \"',parameters('ALERT_INCLUDE_FILTER_RESOURCE_ID'),'\"\n| where _ResourceId !contains \"',parameters('ALERT_EXCLUDE_FILTER_RESOURCE_ID'),'\"\n| where Namespace == \"Processor\" and Name == \"UtilizationPercentage\"')]",
                                  "timeAggregation": "Average",
                                  "metricMeasureColumn": "Val",
                                  "dimensions": [
                                    {
                                      "name": "Computer",
                                      "operator": "Include",
                                      "values": [
                                        "*"
                                      ]
                                    }
                                  ],
                                  "resourceIdColumn": "_ResourceId",
                                  "operator": "GreaterThan",
                                  "threshold": 95,
                                  "failingPeriods": {
                                    "numberOfEvaluationPeriods": 6,
                                    "minFailingPeriodsToAlert": 6
                                  }
                                }
                              ]
                            },
                            "autoMitigate": true

                          }
                        },
                        {
                          "type": "microsoft.insights/scheduledqueryrules",
                          "apiVersion": "2022-06-15",
                          "name": "VM Performance - Low Memory",
                          "Location": "[parameters('Location')]",
                          "properties": {
                            "displayName": "VM Performance - Low Memory",
                            "description": "VM has less than 500mb memory for 30 minutes",
                            "severity": 2,
                            "enabled": true,
                            "evaluationFrequency": "PT10M",
                            "scopes": [
                              "[parameters('LogAnalyticsWorkspaceId')]"
                            ],
                            "targetResourceTypes": [
                              "Microsoft.OperationalInsights/workspaces"
                            ],
                            "windowSize": "PT5M",
                            "criteria": {
                              "allOf": [
                                {
                                  "query": "[concat('InsightsMetrics\n| where Computer contains \"',parameters('ALERT_INCLUDE_FILTER_SERVERNAME'),'\"\n| where _ResourceId contains \"',parameters('ALERT_INCLUDE_FILTER_RESOURCE_ID'),'\"\n| where _ResourceId !contains \"',parameters('ALERT_EXCLUDE_FILTER_RESOURCE_ID'),'\"\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"Memory\" and Name == \"AvailableMB\"')]",
                                  "timeAggregation": "Average",
                                  "metricMeasureColumn": "Val",
                                  "dimensions": [
                                    {
                                      "name": "Computer",
                                      "operator": "Include",
                                      "values": [
                                        "*"
                                      ]
                                    }
                                  ],
                                  "resourceIdColumn": "_ResourceId",
                                  "operator": "LessThan",
                                  "threshold": 500,
                                  "failingPeriods": {
                                    "numberOfEvaluationPeriods": 6,
                                    "minFailingPeriodsToAlert": 6
                                  }
                                }
                              ]
                            },
                            "autoMitigate": true
                          }
                        },
                        {
                          "type": "microsoft.insights/scheduledqueryrules",
                          "apiVersion": "2022-06-15",
                          "name": "VM Availability - Low Disk Space",
                          "Location": "[parameters('Location')]",
                          "properties": {
                            "displayName": "VM Availability - Low Disk Space",
                            "description": "This server has a disk with less than 1gb free space",
                            "severity": 2,
                            "enabled": true,
                            "evaluationFrequency": "PT15M",
                            "scopes": [
                              "[parameters('LogAnalyticsWorkspaceId')]"
                            ],
                            "targetResourceTypes": [
                              "Microsoft.OperationalInsights/workspaces"
                            ],
                            "windowSize": "PT15M",
                            "criteria": {
                              "allOf": [
                                {
                                  "query": "[concat('InsightsMetrics\n| where Computer contains \"',parameters('ALERT_INCLUDE_FILTER_SERVERNAME'),'\"\n| where _ResourceId contains \"',parameters('ALERT_INCLUDE_FILTER_RESOURCE_ID'),'\"\n| where _ResourceId !contains \"',parameters('ALERT_EXCLUDE_FILTER_RESOURCE_ID'),'\"\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"LogicalDisk\" and Name == \"FreeSpaceMB\"\n| extend Disk=tostring(todynamic(Tags)[\"vm.azm.ms/mountId\"])\n| where Disk !contains \"boot\"\n| summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId, Disk')]",
                                  "timeAggregation": "Average",
                                  "metricMeasureColumn": "AggregatedValue",
                                  "dimensions": [
                                    {
                                      "name": "Computer",
                                      "operator": "Include",
                                      "values": [
                                        "*"
                                      ]
                                    },
                                    {
                                      "name": "Disk",
                                      "operator": "Include",
                                      "values": [
                                        "*"
                                      ]
                                    }
                                  ],
                                  "resourceIdColumn": "_ResourceId",
                                  "operator": "LessThanOrEqual",
                                  "threshold": 1000,
                                  "failingPeriods": {
                                    "numberOfEvaluationPeriods": 2,
                                    "minFailingPeriodsToAlert": 2
                                  }
                                }
                              ]
                            },
                            "autoMitigate": true
                          }
                        },
                        {
                          "type": "microsoft.insights/scheduledqueryrules",
                          "apiVersion": "2022-06-15",
                          "name": "VM Availability - Server Offline",
                          "Location": "[parameters('Location')]",
                          "properties": {
                            "displayName": "VM Availability - Server Offline",
                            "description": "VM is not connecting to Azure Log Analytics",
                            "severity": 1,
                            "enabled": true,
                            "evaluationFrequency": "PT5M",
                            "scopes": [
                              "[parameters('LogAnalyticsWorkspaceId')]"
                            ],
                            "targetResourceTypes": [
                              "Microsoft.OperationalInsights/workspaces"
                            ],
                            "windowSize": "P2D",
                            "criteria": {
                              "allOf": [
                                {
                                  "query": "[concat('Heartbeat\n| where Computer contains \"',parameters('ALERT_INCLUDE_FILTER_SERVERNAME'),'\"\n| where _ResourceId contains \"',parameters('ALERT_INCLUDE_FILTER_RESOURCE_ID'),'\"\n| where _ResourceId !contains \"',parameters('ALERT_EXCLUDE_FILTER_RESOURCE_ID'),'\"\n| summarize TimeGenerated=max(TimeGenerated) by Computer, _ResourceId\n| extend Duration = datetime_diff(\"minute\", now(), TimeGenerated)\n| summarize AggregatedValue = min(Duration) by Computer, bin(TimeGenerated, 5m), _ResourceId\n')]",
                                  "timeAggregation": "Average",
                                  "metricMeasureColumn": "AggregatedValue",
                                  "dimensions": [
                                    {
                                      "name": "Computer",
                                      "operator": "Include",
                                      "values": [
                                        "*"
                                      ]
                                    }
                                  ],
                                  "resourceIdColumn": "_ResourceId",
                                  "operator": "GreaterThan",
                                  "threshold": 5,
                                  "failingPeriods": {
                                    "numberOfEvaluationPeriods": 1,
                                    "minFailingPeriodsToAlert": 1
                                  }
                                }
                              ]
                            },
                            "autoMitigate": true
                          }
                        },
                        {
                            "name": "[parameters('workbookId')]",
                            "type": "microsoft.insights/workbooks",
                            "Location": "[parameters('Location')]",
                            "apiVersion": "2022-04-01",
                            "dependsOn": [],
                            "kind": "shared",
                            "properties": {
                            "displayName": "Monitoring Configuration",
                            "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"a58c3ea1-76a0-46aa-bd18-14d3084875b6\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"fe143a7a-5ec1-4a26-869b-7c7f4a0ba6ea\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Details\",\"subTarget\":\"Details-NEW\",\"style\":\"link\"}]},\"name\":\"links - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Monitoring Policy\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{subscription}\"],\"parameters\":[{\"id\":\"7aae2c7c-6b5a-4a12-9c88-eefe7900e610\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"subscription\",\"label\":\"Subscription\",\"type\":6,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":null},{\"id\":\"40f5c83d-1a82-4186-83f9-934e125bef19\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PolicyAssignments\",\"label\":\"Policy Assignments\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources\\r\\n| where type == \\\"microsoft.authorization/policyassignments\\\"\\r\\n| extend DisplayName = tostring(properties.displayName)\\r\\n| extend policyDefinitionId = tostring(properties.policyDefinitionId)\\r\\n| project name,DisplayName,policyDefinitionId\\r\\n| join kind=leftouter (\\r\\npolicyresources\\r\\n| where type in (\\\"microsoft.authorization/policydefinitions\\\",\\\"microsoft.authorization/policysetdefinitions\\\")\\r\\n| extend PolicyDefinitionName = tostring(properties.displayName)\\r\\n| extend name = tostring(name)\\r\\n| extend Category = properties.metadata.category\\r\\n| project PolicyDefinitionName,Category,name,id\\r\\n) on $left.policyDefinitionId == $right.id\\r\\n| where Category == \\\"Monitoring\\\"\\r\\n| project name,DisplayName\\r\\n| order by DisplayName asc\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 3 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\r\\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\r\\n| extend complianceState = tostring(properties.complianceState)\\r\\n| extend\\r\\n\\tresourceId = tostring(properties.resourceId),\\r\\n\\tpolicyAssignmentId = tostring(properties.policyAssignmentId),\\r\\n\\tpolicyAssignmentScope = tostring(properties.policyAssignmentScope),\\r\\n\\tpolicyAssignmentName = tostring(properties.policyAssignmentName),\\r\\n\\tpolicyDefinitionId = tostring(properties.policyDefinitionId),\\r\\n\\tpolicyDefinitionReferenceId = tostring(properties.policyDefinitionReferenceId),\\r\\n\\tstateWeight = iff(complianceState == 'NonCompliant', int(300), iff(complianceState == 'Compliant', int(200), iff(complianceState == 'Conflict', int(100), iff(complianceState == 'Exempt', int(50), int(0)))))\\r\\n| summarize max(stateWeight) by resourceId, policyAssignmentId, policyAssignmentScope, policyAssignmentName\\r\\n| summarize counts = count() by policyAssignmentId, policyAssignmentScope, max_stateWeight, policyAssignmentName\\r\\n| summarize overallStateWeight = max(max_stateWeight),\\r\\nnonCompliantCount = sumif(counts, max_stateWeight == 300),\\r\\ncompliantCount = sumif(counts, max_stateWeight == 200),\\r\\nconflictCount = sumif(counts, max_stateWeight == 100),\\r\\nexemptCount = sumif(counts, max_stateWeight == 50) by policyAssignmentId, policyAssignmentScope, policyAssignmentName\\r\\n| extend totalResources = todouble(nonCompliantCount + compliantCount + conflictCount + exemptCount)\\r\\n| extend compliancePercentage = iff(totalResources == 0, todouble(100), 100 * todouble(compliantCount + exemptCount) / totalResources)\\r\\n| project \\r\\ncomplianceState = iff(overallStateWeight == 300, 'noncompliant', iff(overallStateWeight == 200, 'compliant', iff(overallStateWeight == 100, 'conflict', iff(overallStateWeight == 50, 'exempt', 'notstarted')))),\\r\\npolicyAssignmentName, scope = policyAssignmentScope,\\r\\ncompliancePercentage,\\r\\ncompliantCount,\\r\\nnonCompliantCount,\\r\\nconflictCount,\\r\\nexemptCount\\r\\n| where policyAssignmentName in ({PolicyAssignments})\\r\\n| join kind=leftouter (\\r\\npolicyresources\\r\\n| where type == \\\"microsoft.authorization/policyassignments\\\"\\r\\n| extend name=tostring(name)\\r\\n| extend DisplayName = tostring(properties.displayName)\\r\\n| project name,DisplayName\\r\\n) on $left.policyAssignmentName == $right.name\\r\\n| project complianceState,DisplayName,scope,compliancePercentage,compliantCount,nonCompliantCount,conflictCount,exemptCount\\r\\n\\r\\n\",\"size\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"complianceState\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"compliant\",\"representation\":\"success\",\"text\":\"[\\\"DisplayName\\\"]\"},{\"operator\":\"==\",\"thresholdValue\":\"noncompliant\",\"representation\":\"4\",\"text\":\"[\\\"DisplayName\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"[\\\"DisplayName\\\"]\"}],\"customColumnWidthSetting\":\"47.4286ch\"}},{\"columnMatch\":\"DisplayName\",\"formatter\":5},{\"columnMatch\":\"compliancePercentage\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"redGreen\",\"customColumnWidthSetting\":\"143px\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"policyAssignmentName\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"complianceState\",\"label\":\"Policy Assignment\"},{\"columnId\":\"DisplayName\",\"label\":\"DisplayName\"},{\"columnId\":\"scope\",\"label\":\"Scope\"},{\"columnId\":\"compliancePercentage\",\"label\":\"Compliance\"},{\"columnId\":\"compliantCount\",\"label\":\"Compliant\"},{\"columnId\":\"nonCompliantCount\",\"label\":\"Non-Compliant\"},{\"columnId\":\"conflictCount\",\"label\":\"Conflict\"},{\"columnId\":\"exemptCount\",\"label\":\"Exempt\"}]}},\"name\":\"query - 4\"}]},\"customWidth\":\"90\",\"name\":\"Monitoring Configuration Group\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Monitoring Data\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{subscription}\"],\"parameters\":[{\"id\":\"d034ef1f-1b9d-4e40-b40b-51bbcf47c348\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"subscription\",\"label\":\"Subscription\",\"type\":6,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":null},{\"id\":\"1fac4c70-2a0f-4810-ab8a-868b75209327\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"workspace\",\"label\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project value = id, label = name\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":null},{\"id\":\"eb8bac5b-f20f-4ca1-a79a-5a691dba1463\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceType\",\"label\":\"Resource Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"jsonData\":\" [\\\"Virtual Machine\\\", \\\"VM Scale Set\\\",\\\"Azure Arc Machine\\\"]\",\"defaultValue\":\"value::all\",\"value\":[\"value::all\"]},{\"id\":\"ede20336-9383-4814-9a16-7841b7915c04\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OSType\",\"label\":\"OS Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.compute/virtualmachines\\\"\\r\\n| extend OSType = tolower(tostring(properties.storageProfile.osDisk.osType))\\r\\n| union\\r\\n(\\r\\nresources\\r\\n| where type == \\\"microsoft.hybridcompute/machines\\\"\\r\\n| extend OSType = tolower(tostring(properties.osType))\\r\\n)\\r\\n| union \\r\\n(\\r\\nresources\\r\\n| where type == \\\"microsoft.compute/virtualmachinescalesets\\\"\\r\\n| extend OSType = tolower(tostring(properties.virtualMachineProfile.storageProfile.osDisk.osType))\\r\\n) \\r\\n|distinct OSType\\r\\n| extend OSType = case(OSType=~\\\"windows\\\",\\\"Windows\\\",(case(OSType=~\\\"linux\\\",\\\"Linux\\\",OSType)))\\r\\n\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"c67fa407-70bb-4dd9-880b-9af3e90e97fb\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceGroup\",\"label\":\"Resource Group\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| where type in (\\\"microsoft.compute/virtualmachines\\\",\\\"microsoft.compute/virtualmachinescalesets\\\",\\\"microsoft.hybridcompute/machines\\\")\\r\\n| distinct resourceGroup\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.resources/resourcegroups\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"91166e8d-2338-4ab8-bceb-080c3cf32a45\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ARGQuery\",\"type\":1,\"query\":\"//Virtual Machines\\r\\nresources\\r\\n| where type == \\\"microsoft.compute/virtualmachines\\\"\\r\\n| extend PowerStatus = tostring(properties.extended.instanceView.powerState.displayStatus),\\r\\n\\tOSType = tostring(properties.storageProfile.osDisk.osType),\\r\\n    IdentityType = identity.type,\\r\\n    ComputerName = tolower(name)\\r\\n| extend ResourceType=\\\"Virtual Machine\\\"\\r\\n| extend patchSettings = iff(properties.storageProfile.osDisk.osType =~ \\\"windows\\\", properties.osProfile.windowsConfiguration.patchSettings, properties.osProfile.linuxConfiguration.patchSettings)\\r\\n| extend patchMode = patchSettings.patchMode\\r\\n| extend patchMode = case(patchMode =~ 'AutomaticByOS', 'Windows Automatic Updates', patchMode =~ 'ImageDefault', 'Image default', (patchMode =~ 'AutomaticByPlatform' and patchSettings.automaticByPlatformSettings.bypassPlatformSafetyChecksOnUserSchedule == true), 'Customer Managed Schedules', patchMode =~ 'AutomaticByPlatform', 'Azure Managed - Safe Deployment', patchMode)\\r\\n| extend patchMode=tostring(patchMode)\\r\\n| extend assessmentMode = tostring(patchSettings.assessmentMode)\\r\\n| project ComputerName, id, Location, resourceGroup, PowerStatus, OSType, IdentityType,ResourceType,patchMode,assessmentMode\\r\\n    //Virtual Machines - Installed Extensions\\r\\n    | join kind=leftouter (\\r\\n    resources\\r\\n    | where type contains \\\"microsoft.compute/virtualmachines/extensions\\\"\\r\\n    | extend publisher = properties.publisher\\r\\n    | parse id with * \\\"/virtualMachines/\\\" ComputerName \\\"/\\\" *\\r\\n    | extend extensionType = properties.type, \\r\\n        status = tostring(properties.provisioningState),\\r\\n        version = properties.typeHandlerVersion,\\r\\n        ComputerName = tolower(ComputerName)\\r\\n    | where status in (\\\"Succeeded\\\",\\\"Updating\\\")\\r\\n    | summarize InstalledExtensions = make_list(publisher) by ComputerName\\r\\n    ) on ComputerName\\r\\n| union\\r\\n(\\r\\n//VM Scale Sets\\r\\nresources\\r\\n| where type == \\\"microsoft.compute/virtualmachinescalesets\\\"\\r\\n| extend ResourceType=\\\"VM Scale Set\\\"\\r\\n| extend PowerStatus = tostring(properties.extended.instanceView.powerState.displayStatus),\\r\\n    OSType = tostring(properties.virtualMachineProfile.storageProfile.osDisk.osType),\\r\\n    IdentityType = identity.type,\\r\\n    ComputerName = tolower(name)\\r\\n| project ComputerName, id, Location, resourceGroup, PowerStatus, OSType, IdentityType,ResourceType\\r\\n    //VM Scale Sets - Installed Extensions\\r\\n    | join kind=leftouter(\\r\\n    resources\\r\\n    | where type == \\\"microsoft.compute/virtualmachinescalesets\\\"\\r\\n    | extend ComputerName = tolower(name)\\r\\n    | mv-expand extensionProfile = properties.virtualMachineProfile.extensionProfile.extensions\\r\\n    | project ComputerName, extensionName = extensionProfile.properties.publisher\\r\\n    | extend extensionName=tostring(extensionName)\\r\\n    | summarize InstalledExtensions = make_list(extensionName) by ComputerName\\r\\n    ) on ComputerName\\r\\n)\\r\\n| union\\r\\n(\\r\\n//Azure Arc machines\\r\\nresources\\r\\n| where type == \\\"microsoft.hybridcompute/machines\\\"\\r\\n| extend PowerStatus = tostring(properties.status),\\r\\n\\tOSType = tostring(properties.osType),\\r\\n    IdentityType = identity.type,\\r\\n    ComputerName = tolower(name)\\r\\n| extend ResourceType=\\\"Azure Arc Machine\\\"\\r\\n| extend patchSettings = properties.osProfile.windowsConfiguration.patchSettings\\r\\n| extend assessmentMode = tostring(patchSettings.assessmentMode)\\r\\n| project ComputerName, id, Location, resourceGroup, PowerStatus, OSType, IdentityType,ResourceType,assessmentMode\\r\\n    //Azure Arc Machines - Installed Extensions\\r\\n    | join kind = leftouter\\r\\n    (\\r\\n    resources\\r\\n    | where type contains \\\"microsoft.hybridcompute/machines/extensions\\\"\\r\\n    | extend publisher = properties.publisher\\r\\n        | parse id with * \\\"/Microsoft.HybridCompute/machines/\\\" ComputerName \\\"/\\\" *\\r\\n        | extend extensionType = properties.type, \\r\\n            status = tostring(properties.provisioningState),\\r\\n            version = properties.typeHandlerVersion,\\r\\n            ComputerName = tolower(ComputerName)\\r\\n        | where status in (\\\"Succeeded\\\",\\\"Updating\\\")\\r\\n        | summarize InstalledExtensions = make_list(publisher) by ComputerName\\r\\n    ) on ComputerName\\r\\n    )\\r\\n    | extend AMAStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.Monitor\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend MDEStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.AzureDefenderForServers\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend CTStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.ChangeTrackingAndInventory\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend MMAStatus = case(InstalledExtensions contains \\\"Microsoft.EnterpriseCloud.Monitoring\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend DAStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.Monitoring.DependencyAgent\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n| extend OSType = case(OSType=~\\\"windows\\\",\\\"Windows\\\",(case(OSType=~\\\"linux\\\",\\\"Linux\\\",OSType)))\\r\\n| project ComputerName, ResourceID = tolower(id),ResourceType,Location, resourceGroup, OSType, Status=PowerStatus,AMAStatus,MMAStatus,MDEStatus, CTStatus,DAStatus,patchMode,assessmentMode\\r\\n| extend ResourceType_OS=strcat(OSType,\\\" \\\",ResourceType)\\r\\n//check to see if update manager has run in last 30 days\\r\\n| join kind=leftouter\\r\\n(\\r\\nmaintenanceresources\\r\\n| where ['type'] == \\\"microsoft.maintenance/applyupdates\\\"\\r\\n| where properties.maintenanceScope == \\\"InGuestPatch\\\"\\r\\n| extend ComputerName = tolower(tostring(split(id,'/')[8]))\\r\\n| extend StartTime = todatetime(properties.startDateTime)\\r\\n| summarize LastUpdate = max(StartTime) by ComputerName\\r\\n| extend TimeFromNow = now() - LastUpdate\\r\\n| extend DaysSinceUpdate = toint(TimeFromNow / 1d)\\r\\n| extend UpdatedRecently = case(DaysSinceUpdate<30,\\\"Yes\\\",\\\"No\\\")\\r\\n| project ComputerName,UpdatedRecently\\r\\n) on ComputerName\\r\\n//////////// EXCLUDE LIST ////////////\\r\\n//////////// EXCLUDE LIST ////////////\\r\\n| where ComputerName !contains \\\"EXCLUDED_COMPUTER_1\\\" and ComputerName !contains \\\"EXCLUDED_COMPUTER_1\\\"\\r\\n//////////// EXCLUDE LIST ////////////\\r\\n//////////// EXCLUDE LIST ////////////\\r\\n//////////// FILTERS ////////////\\r\\n| where (OSType in ({OSType}) and ResourceType in ({ResourceType}) and resourceGroup in ({ResourceGroup}))\\r\\n//////////// FILTERS ////////////\\r\\n| project-away ComputerName,ComputerName1\\r\\n| extend bag = pack(\\\"ResourceID\\\",ResourceID,\\\"ResourceType\\\",ResourceType,\\\"ResourceType_OS\\\",ResourceType_OS,\\\"Location\\\",Location,\\\"resourceGroup\\\",resourceGroup,\\\"OSType\\\",OSType,\\\"Status\\\",Status,\\\"AMAStatus\\\",AMAStatus,\\\"MMAStatus\\\",MMAStatus,\\\"MDEStatus\\\",MDEStatus,\\\"CTStatus\\\",CTStatus,\\\"DAStatus\\\",DAStatus,\\\"patchMode\\\",patchMode,\\\"assessmentMode\\\",assessmentMode,\\\"UpdatedRecently\\\",UpdatedRecently)\\r\\n| summarize tostring(make_list(bag))\",\"crossComponentResources\":[\"{subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 3 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let arg = materialize(datatable(row:string) ['{ARGQuery}']\\r\\n| project row = todynamic(row)\\r\\n| mv-expand row\\r\\n| evaluate bag_unpack(row));\\r\\narg\\r\\n| project ResourceID,resourceGroup,Location,ResourceType,ResourceType_OS,OSType,Status,AMAStatus,CTStatus,DAStatus,MDEStatus,assessmentMode,patchMode, UpdatedRecently\\r\\n| extend MDEStatus = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",MDEStatus)\\r\\n| summarize Count=count(),Online=count(Status in (\\\"VM running\\\",\\\"Connected\\\",\\\"\\\")),AMAStatus=count(AMAStatus == \\\"Installed\\\"),CTStatus=count(CTStatus == \\\"Installed\\\"),DAStatus=count(DAStatus==\\\"Installed\\\"),MDEStatus=count(MDEStatus == \\\"Installed\\\"), UpdateSchedule=count(patchMode==\\\"Customer Managed Schedules\\\"),UpdateAssessment=count(assessmentMode==\\\"AutomaticByPlatform\\\"),UpdatedRecently=count(UpdatedRecently==\\\"Yes\\\") by ResourceType_OS\\r\\n//| summarize Count=count(),MonitoringCount=count(AMAState == \\\"Connected\\\" and VMInsightsState==\\\"Connected\\\" and ChangeTrackingState==\\\"Connected\\\"),SecurityEventConnectedCount=count(SecurityEventState==\\\"Connected\\\"), SyslogConnectedCount=count(SyslogState==\\\"Connected\\\"),MDConnectedCount=count(MDEState==\\\"Connected\\\"),AzureUpdateManager=count(patchMode==\\\"Customer Managed Schedules\\\" and assessmentMode==\\\"AutomaticByPlatform\\\" and UpdatedRecently==\\\"Yes\\\") by ResourceType_OS\\r\\n\",\"size\":3,\"title\":\"VM Configuration\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":5},{\"columnMatch\":\"Online\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"1\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}]}},{\"columnMatch\":\"AMAStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Count\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}],\"customColumnWidthSetting\":\"26.8571ch\"}},{\"columnMatch\":\"CTStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Count\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}],\"customColumnWidthSetting\":\"30ch\"}},{\"columnMatch\":\"DAStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Linux\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Count\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}]}},{\"columnMatch\":\"MDEStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Scale Set\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Count\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}]}},{\"columnMatch\":\"UpdateSchedule\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Scale Set\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Count\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}]}},{\"columnMatch\":\"UpdateAssessment\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Scale Set\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Count\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}]}},{\"columnMatch\":\"UpdatedRecently\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Scale Set\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Count\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Count\\\"]\"}]}}],\"labelSettings\":[{\"columnId\":\"ResourceType_OS\",\"label\":\"Resource Type\"},{\"columnId\":\"AMAStatus\",\"label\":\"Azure Monitor Agent\"},{\"columnId\":\"CTStatus\",\"label\":\"Change Tracking Extension\"},{\"columnId\":\"DAStatus\",\"label\":\"Dependency Agent\"},{\"columnId\":\"MDEStatus\",\"label\":\"MDE Extension\"},{\"columnId\":\"UpdateSchedule\",\"label\":\"Update Schedule\"},{\"columnId\":\"UpdateAssessment\",\"label\":\"Update Assessment\"},{\"columnId\":\"UpdatedRecently\",\"label\":\"Updated Recently\"}]},\"sortBy\":[]},\"name\":\"query - 3 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let arg = materialize(datatable(row:string) ['{ARGQuery}']\\r\\n| project row = todynamic(row)\\r\\n| mv-expand row\\r\\n| evaluate bag_unpack(row));\\r\\narg\\r\\n| project ResourceID,resourceGroup,Location,ResourceType,ResourceType_OS,OSType,Status,AMAStatus,CTStatus,MDEStatus,assessmentMode,patchMode, UpdatedRecently\\r\\n| join kind=leftouter\\r\\n(\\r\\n//AMA Heartbeat\\r\\nHeartbeat\\r\\n| where TimeGenerated >ago(30d)\\r\\n| where Category == \\\"Azure Monitor Agent\\\"\\r\\n| where ResourceType =~ \\\"virtualMachines\\\" or ResourceType =~ \\\"virtualMachineScaleSets\\\" or ResourceType =~ \\\"machines\\\"\\r\\n| summarize LastAMAHeartbeat = arg_max(TimeGenerated,ResourceId,OSType,ResourceType,ResourceGroup,SubscriptionId) by Computer//ResourceId, Computer,OSType\\r\\n| extend ResourceId = tolower(ResourceId)\\r\\n| extend ResourceId = case(ResourceType =~ \\\"virtualMachineScaleSets\\\", split(ResourceId,\\\"/virtualmachines/\\\")[0],ResourceId)\\r\\n| extend Computer=case(ResourceType=~\\\"virtualmachinescalesets\\\",split(ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastAMAHeartbeat = arg_max(LastAMAHeartbeat,ResourceId,OSType,ResourceType,ResourceGroup,SubscriptionId) by Computer//ResourceId, Computer,OSType\\r\\n| extend ResourceType=tolower(ResourceType)\\r\\n| extend ResourceGroup = toupper(ResourceGroup)\\r\\n| extend Computer = toupper(Computer) \\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend TimeFromNow = now() - LastAMAHeartbeat\\r\\n| extend AMAHeartbeat = toint(TimeFromNow / 1s)\\r\\n| join kind=leftouter\\r\\n//VMInsights\\r\\n(\\r\\nInsightsMetrics\\r\\n| where TimeGenerated > ago(2d)\\r\\n| where Origin == \\\"vm.azm.ms\\\"\\r\\n| where Name != \\\"Heartbeat\\\"\\r\\n| summarize LastVMICollection = arg_max(TimeGenerated,*) by _ResourceId\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastVMICollection = max(LastVMICollection) by _ResourceId\\r\\n| extend TimeFromNow = now() - LastVMICollection\\r\\n| extend VMICollection = toint(TimeFromNow / 1s)\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n) on ResourceId\\r\\n| join kind=leftouter\\r\\n//Syslog\\r\\n(\\r\\nSyslog\\r\\n| where TimeGenerated > ago(2d)\\r\\n| summarize LastSyslogCollection = max(TimeGenerated) by Computer,_ResourceId\\r\\n//get Computer name from resource ID since it could be forwarding for another computer\\r\\n| extend RID_split = split(_ResourceId,\\\"/\\\")\\r\\n| extend Computer=tostring(RID_split[8])\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n//| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastSyslogCollection = max(LastSyslogCollection) by Computer,_ResourceId\\r\\n| extend TimeFromNow = now() - LastSyslogCollection\\r\\n| extend SyslogCollection = toint(TimeFromNow / 1s)\\r\\n| extend Computer = toupper(Computer)\\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n) on ResourceId\\r\\n//Sentinel Data\\r\\n| join kind=leftouter \\r\\n(\\r\\nSecurityEvent\\r\\n| where TimeGenerated > ago(2d)\\r\\n| summarize LastSecurityEventCollection = max(TimeGenerated) by Computer,_ResourceId\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastSecurityEventCollection = max(LastSecurityEventCollection) by Computer,_ResourceId\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n| extend Computer = toupper(Computer)\\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend TimeFromNow = now() - LastSecurityEventCollection\\r\\n| extend SecurityEventCollection = toint(TimeFromNow / 1s)\\r\\n) on ResourceId\\r\\n//Change Tracking data\\r\\n| join kind=leftouter\\r\\n(\\r\\nConfigurationData\\r\\n| where TimeGenerated > ago(2d)\\r\\n| summarize LastChangeTrackingEvent = max(TimeGenerated) by Computer,_ResourceId\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastChangeTrackingEvent = max(LastChangeTrackingEvent) by Computer,_ResourceId\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n| extend Computer = toupper(Computer)\\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend TimeFromNow = now() - LastChangeTrackingEvent\\r\\n| extend ChangeTrackingEventCollection = toint(TimeFromNow / 1s)\\r\\n) on ResourceId\\r\\n//MDE Data\\r\\n//| join kind=leftouter\\r\\n//(\\r\\n//DeviceInfo\\r\\n//| where TimeGenerated > ago(4h)\\r\\n//| where SensorHealthState ==\\\"Active\\\"\\r\\n//| where OnboardingStatus == \\\"Onboarded\\\"\\r\\n//| summarize LastDeviceInfo = max(TimeGenerated) by DeviceName\\r\\n//| extend Computer = toupper(DeviceName)\\r\\n//| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n//| extend TimeFromNow = now() - LastDeviceInfo\\r\\n//| extend DeviceInfoSeconds = toint(TimeFromNow / 1s)\\r\\n//) on Computer\\r\\n//Put it all together\\r\\n//| extend MDEState = case (LastDeviceInfo>ago(4h) and ResourceType!=\\\"virtualmachinescalesets\\\",\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n//| extend MDEState = case(ResourceType==\\\"virtualmachinescalesets\\\",\\\"n/a\\\",MDEState)\\r\\n| extend AMAState = case (LastAMAHeartbeat>ago(5m),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend VMInsightsState = case (LastVMICollection>ago(5m),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend SyslogState = case (LastSyslogCollection>ago(30m) and (OSType==\\\"Linux\\\"),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend SyslogState = case (OSType==\\\"Windows\\\",\\\"n/a\\\",SyslogState)\\r\\n| extend SyslogCollection = case (OSType==\\\"Windows\\\",-222,isempty(SyslogCollection),-1, SyslogCollection)\\r\\n| extend SecurityEventState = case (LastSecurityEventCollection>ago(10m) and (OSType==\\\"Windows\\\"),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend SecurityEventState = case (OSType==\\\"Linux\\\",\\\"n/a\\\",SecurityEventState)\\r\\n| extend ChangeTrackingState = case (LastChangeTrackingEvent>ago(1d),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| project Computer,ResourceType,OSType,SubscriptionId,ResourceGroup,ResourceId,AMAState,VMInsightsState,SyslogState,SecurityEventState,ChangeTrackingState,AMAHeartbeat,VMICollection,SyslogCollection,SecurityEventCollection,ChangeTrackingEventCollection\\r\\n| extend ResourceType = case(ResourceType==\\\"virtualmachines\\\",\\\"Virtual Machine\\\",ResourceType==\\\"virtualmachinescalesets\\\",\\\"VM Scale Set\\\",ResourceType=='machines',\\\"Azure Arc Machine\\\",ResourceType)\\r\\n| extend ResourceGroup=tolower(ResourceGroup)\\r\\n//| where OSType in ({OSType}) and ResourceGroup in ({ResourceGroup}) and ResourceType in ({ResourceType})\\r\\n//| extend ResourceType = case(ResourceType==\\\"Virtual Machine\\\",\\\"VM\\\",ResourceType)\\r\\n//| extend ResourceType_OS=strcat(OSType,\\\" \\\",ResourceType)\\r\\n)\\r\\non $left.ResourceID == $right.ResourceId\\r\\n//| extend MDEStatus = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",MDEStatus)\\r\\n//| where AMAState != \\\"Connected\\\" or VMInsightsState != \\\"Connected\\\" or SyslogState !in (\\\"Connected\\\",\\\"n/a\\\") or SecurityEventState !in (\\\"Connected\\\",\\\"n/a\\\") or ChangeTrackingState != \\\"Connected\\\" or MDEState !in (\\\"Connected\\\",\\\"n/a\\\") or AMAStatus != \\\"Installed\\\" or CTStatus!= \\\"Installed\\\" or MDEStatus !in (\\\"Installed\\\",\\\"n/a\\\")\\r\\n//| project ResourceID,resourceGroup,Location,ResourceType,OSType,Status,AMAStatus,CTStatus,MDEStatus,AMAHeartbeat,VMICollection,SyslogCollection,SecurityEventCollection,ChangeTrackingEventCollection,DeviceInfoSeconds,AMAState,MDEState,VMInsightsState,SyslogState,SecurityEventState,ChangeTrackingState, ResourceType_OS\\r\\n| summarize Count=count(),Online=count(Status in (\\\"VM running\\\",\\\"Connected\\\",\\\"\\\")),AMAConnectedCount=count(AMAState == \\\"Connected\\\"),VMInsightsConnectedCount=count(VMInsightsState==\\\"Connected\\\"), ChangeTrackingConnectedCount=count(ChangeTrackingState==\\\"Connected\\\"),SecurityEventConnectedCount=count(SecurityEventState==\\\"Connected\\\"), SyslogConnectedCount=count(SyslogState==\\\"Connected\\\") by ResourceType_OS\\r\\n//| summarize Count=count(),MonitoringCount=count(AMAState == \\\"Connected\\\" and VMInsightsState==\\\"Connected\\\" and ChangeTrackingState==\\\"Connected\\\"),SecurityEventConnectedCount=count(SecurityEventState==\\\"Connected\\\"), SyslogConnectedCount=count(SyslogState==\\\"Connected\\\"),MDConnectedCount=count(MDEState==\\\"Connected\\\"),AzureUpdateManager=count(patchMode==\\\"Customer Managed Schedules\\\" and assessmentMode==\\\"AutomaticByPlatform\\\" and UpdatedRecently==\\\"Yes\\\") by ResourceType_OS\\r\\n\",\"size\":3,\"title\":\"Data Collection\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":5},{\"columnMatch\":\"Online\",\"formatter\":5},{\"columnMatch\":\"AMAConnectedCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Online\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"}]}},{\"columnMatch\":\"VMInsightsConnectedCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Online\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"}]}},{\"columnMatch\":\"ChangeTrackingConnectedCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Online\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"}]}},{\"columnMatch\":\"SecurityEventConnectedCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Linux\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Online\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"}]}},{\"columnMatch\":\"SyslogConnectedCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Windows\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Online\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"}]}},{\"columnMatch\":\"MDConnectedCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Scale Set\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"<\",\"thresholdValue\":\"[\\\"Online\\\"]\",\"representation\":\"4\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1} / [\\\"Online\\\"]\"}]}}],\"labelSettings\":[{\"columnId\":\"ResourceType_OS\",\"label\":\"Resource Type\"},{\"columnId\":\"AMAConnectedCount\",\"label\":\"Heartbeat\"},{\"columnId\":\"VMInsightsConnectedCount\",\"label\":\"VM Insights\"},{\"columnId\":\"ChangeTrackingConnectedCount\",\"label\":\"Change Tracking\"},{\"columnId\":\"SecurityEventConnectedCount\",\"label\":\"Sentinel\"},{\"columnId\":\"SyslogConnectedCount\",\"label\":\"Syslog\"}]},\"sortBy\":[]},\"name\":\"query - 3\",\"styleSettings\":{\"showBorder\":true}}]},\"name\":\"Monitoring Data Group\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"Overview Group\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Monitoring Configuration Compliance (Azure Policy)\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{subscription}\"],\"parameters\":[{\"id\":\"0192e2b5-4683-4347-8f9b-48fff727005a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"subscription\",\"label\":\"Subscription\",\"type\":6,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":\"/subscriptions/93e078d2-5dcc-4825-8290-f8fa50912c40\"},{\"id\":\"3314507e-2772-4b8e-81b7-d1efb45f82e1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PolicyAssignments\",\"label\":\"Policy Assignments\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources\\r\\n| where type == \\\"microsoft.authorization/policyassignments\\\"\\r\\n| extend DisplayName = tostring(properties.displayName)\\r\\n| extend policyDefinitionId = tostring(properties.policyDefinitionId)\\r\\n| project name,DisplayName,policyDefinitionId\\r\\n| join kind=leftouter (\\r\\npolicyresources\\r\\n| where type in (\\\"microsoft.authorization/policydefinitions\\\",\\\"microsoft.authorization/policysetdefinitions\\\")\\r\\n| extend PolicyDefinitionName = tostring(properties.displayName)\\r\\n| extend name = tostring(name)\\r\\n| extend Category = properties.metadata.category\\r\\n| project PolicyDefinitionName,Category,name,id\\r\\n) on $left.policyDefinitionId == $right.id\\r\\n| where Category == \\\"Monitoring\\\"\\r\\n| project name,DisplayName\\r\\n| order by DisplayName asc\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"71f72d48-b28a-473e-8285-9c47f08e90bc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Compliance\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"PolicyResources\\r\\n| where type == 'microsoft.policyinsights/policystates'\\r\\n| extend ComplianceState = tostring(properties.complianceState)\\r\\n| distinct ComplianceState\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"NonCompliant\"]}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - 3 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"PolicyResources\\r\\n| where type == 'microsoft.policyinsights/policystates'\\r\\n| extend Resource = tostring(properties.resourceId), policyAssignmentName = tostring(properties.policyAssignmentName), PolicyDefinitionReferenceID = tostring(properties.policyDefinitionReferenceId),ComplianceState = tostring(properties.complianceState)\\r\\n| where policyAssignmentName in ({PolicyAssignments})\\r\\n//| where ComplianceState == 'NonCompliant'\\r\\n| where ComplianceState in ({Compliance})\\r\\n| project Resource,policyAssignmentName,PolicyDefinitionReferenceID,ComplianceState\\r\\n| join kind=leftouter (\\r\\npolicyresources\\r\\n| where type == \\\"microsoft.authorization/policyassignments\\\"\\r\\n| extend name=tostring(name)\\r\\n| extend PolicyAssignmentDisplayName = tostring(properties.displayName)\\r\\n| extend policyDefinitionId = tostring(properties.policyDefinitionId)\\r\\n//| project name,PolicyAssignmentDisplayName\\r\\n| where PolicyAssignmentDisplayName contains \\\"monitor\\\"\\r\\n) on $left.policyAssignmentName == $right.name\\r\\n| where PolicyAssignmentDisplayName contains \\\"monitor\\\"\\r\\n| project Resource, policyAssignmentName,PolicyAssignmentDisplayName,PolicyDefinitionReferenceID,policyDefinitionId,ComplianceState\\r\\n//| project Resource,DisplayName,PolicyDefinitionReferenceID\\r\\n| join kind=leftouter (\\r\\nPolicyResources\\r\\n| where type in (\\\"microsoft.authorization/policydefinitions\\\",\\\"microsoft.authorization/policysetdefinitions\\\")\\r\\n//| where id in (\\\"/subscriptions/93e078d2-5dcc-4825-8290-f8fa50912c40/providers/Microsoft.Authorization/policyDefinitions/4a5867f7-bed4-4d69-aa44-30cb18fbe7ec\\\")\\r\\n| extend PolicyDisplayName = tostring(properties.displayName)\\r\\n| project id,PolicyDisplayName\\r\\n) on $left.policyDefinitionId == $right.id\\r\\n| extend PolicyReference = case(isempty(PolicyDefinitionReferenceID),PolicyDisplayName,PolicyDefinitionReferenceID)\\r\\n| project ComplianceState,Resource,PolicyAssignmentDisplayName,PolicyReference//,PolicyDefinitionReferenceID,PolicyDisplayName\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ComplianceState\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Compliant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"NonCompliant\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"20.7143ch\"}},{\"columnMatch\":\"Resource\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"21.7143ch\"}},{\"columnMatch\":\"PolicyAssignmentDisplayName\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"45.4286ch\"}},{\"columnMatch\":\"PolicyReference\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"50ch\"}}],\"rowLimit\":1000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_link_Resource_1\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"ComplianceState\",\"label\":\"Compliant\"},{\"columnId\":\"Resource\",\"label\":\"Resource\"},{\"columnId\":\"PolicyAssignmentDisplayName\",\"label\":\"Policy Assignment\"},{\"columnId\":\"PolicyReference\",\"label\":\"Policy Name / Reference\"}]},\"sortBy\":[{\"itemKey\":\"$gen_link_Resource_1\",\"sortOrder\":1}]},\"name\":\"query - 0\"}]},\"customWidth\":\"75\",\"name\":\"PolicyConfigGroup\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Monitoring Data Collection\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"3797ff22-02e9-409c-98b2-52332adb2093\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"subscription\",\"label\":\"Subscription\",\"type\":6,\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":\"/subscriptions/93e078d2-5dcc-4825-8290-f8fa50912c40\"},{\"id\":\"e3495651-66ef-44cd-829f-f6e2d91482fe\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"workspace\",\"label\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project value = id, label = name\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"/subscriptions/93e078d2-5dcc-4825-8290-f8fa50912c40/resourceGroups/ALA-RG/providers/Microsoft.OperationalInsights/workspaces/ALA-MAIN\"},{\"id\":\"601ff709-9c1b-4ea3-aecd-9aea8e0a2dda\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceType\",\"label\":\"Resource Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"jsonData\":\" [\\\"Virtual Machine\\\", \\\"VM Scale Set\\\",\\\"Azure Arc Machine\\\"]\",\"defaultValue\":\"value::all\",\"value\":[\"value::all\"]},{\"id\":\"3ceb587b-c08a-4317-8a00-bd63e5e871fd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Location\",\"label\":\"Location\",\"type\":8,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.compute/virtualmachines\\\"\\r\\n| distinct Location\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"0866f476-e27c-4b82-a070-fac926cacfb8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OSType\",\"label\":\"OS Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.compute/virtualmachines\\\"\\r\\n| extend OSType = tostring(properties.storageProfile.osDisk.osType)\\r\\n| distinct OSType\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"ce61a86b-e47d-4675-a574-9144475b9dad\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceGroup\",\"label\":\"Resource Group\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| where type in (\\\"microsoft.compute/virtualmachines\\\",\\\"microsoft.compute/virtualmachinescalesets\\\",\\\"microsoft.hybridcompute/machines\\\")\\r\\n| distinct resourceGroup\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.resources/resourcegroups\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]},{\"id\":\"b9540fc1-3197-4fd9-aecb-8b52141a6ba0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PowerStatus\",\"label\":\"Status\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| where type == \\\"microsoft.compute/virtualmachines\\\"\\r\\n| extend PowerStatus = tostring(properties.extended.instanceView.powerState.displayStatus)\\r\\n| union\\r\\n(\\r\\n//Azure Arc machines\\r\\nresources\\r\\n| where type == \\\"microsoft.hybridcompute/machines\\\"\\r\\n| extend PowerStatus = tostring(properties.status)\\r\\n)\\r\\n| distinct PowerStatus\",\"crossComponentResources\":[\"{subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"Connected\",\"VM running\"]},{\"id\":\"dcb73aa8-4420-42ab-b793-5b49d2c2d478\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ConfigurationFilter\",\"label\":\"Configuration Filter\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\" [\\\"Show all VMs\\\", \\\"Show all VMs with issues\\\", \\\"AMA Not Installed\\\",\\\"Dependency Agent Not Installed\\\", \\\"Change Tracking Extension Not Installed\\\", \\\"MDE Extension Not Installed\\\", \\\"Azure Update Manager Issues\\\"]\",\"value\":[\"Show all VMs with issues\"]},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"DataCollectionFilter\",\"label\":\"Data Collection Filter\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\" [\\\"Show all VMs\\\", \\\"Show all VMs with issues\\\", \\\"No Heartbeat\\\",\\\"No VM Insights Data\\\", \\\"No Change Tracking Data\\\", \\\"No Syslog Data\\\", \\\"No Security Events (Sentinel)\\\", \\\"No MDE Data\\\"]\",\"value\":[\"Show all VMs with issues\"],\"id\":\"75c503e0-10e5-4158-b157-3167a0e310e7\"},{\"id\":\"5bc398eb-5855-484c-b251-1898b4bb3fdf\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ARGQuery\",\"type\":1,\"query\":\"//Virtual Machines\\r\\nresources\\r\\n| where type == \\\"microsoft.compute/virtualmachines\\\"\\r\\n| extend PowerStatus = tostring(properties.extended.instanceView.powerState.displayStatus),\\r\\n\\tOSType = tostring(properties.storageProfile.osDisk.osType),\\r\\n    IdentityType = identity.type,\\r\\n    ComputerName = tolower(name)\\r\\n| extend ResourceType=\\\"Virtual Machine\\\"\\r\\n| extend patchSettings = iff(properties.storageProfile.osDisk.osType =~ \\\"windows\\\", properties.osProfile.windowsConfiguration.patchSettings, properties.osProfile.linuxConfiguration.patchSettings)\\r\\n| extend patchMode = patchSettings.patchMode\\r\\n| extend patchMode = case(patchMode =~ 'AutomaticByOS', 'Windows Automatic Updates', patchMode =~ 'ImageDefault', 'Image default', (patchMode =~ 'AutomaticByPlatform' and patchSettings.automaticByPlatformSettings.bypassPlatformSafetyChecksOnUserSchedule == true), 'Customer Managed Schedules', patchMode =~ 'AutomaticByPlatform', 'Azure Managed - Safe Deployment', patchMode)\\r\\n| extend patchMode=tostring(patchMode)\\r\\n| extend assessmentMode = tostring(patchSettings.assessmentMode)\\r\\n| project ComputerName, id, Location, resourceGroup, PowerStatus, OSType, IdentityType,ResourceType,patchMode,assessmentMode\\r\\n    //Virtual Machines - Installed Extensions\\r\\n    | join kind=leftouter (\\r\\n    resources\\r\\n    | where type contains \\\"microsoft.compute/virtualmachines/extensions\\\"\\r\\n    | extend publisher = properties.publisher\\r\\n    | parse id with * \\\"/virtualMachines/\\\" ComputerName \\\"/\\\" *\\r\\n    | extend extensionType = properties.type, \\r\\n        status = tostring(properties.provisioningState),\\r\\n        version = properties.typeHandlerVersion,\\r\\n        ComputerName = tolower(ComputerName)\\r\\n    | where status in (\\\"Succeeded\\\",\\\"Updating\\\")\\r\\n    | summarize InstalledExtensions = make_list(publisher) by ComputerName\\r\\n    ) on ComputerName\\r\\n| union\\r\\n(\\r\\n//VM Scale Sets\\r\\nresources\\r\\n| where type == \\\"microsoft.compute/virtualmachinescalesets\\\"\\r\\n| extend ResourceType=\\\"VM Scale Set\\\"\\r\\n| extend PowerStatus = tostring(properties.extended.instanceView.powerState.displayStatus),\\r\\n    OSType = tostring(properties.virtualMachineProfile.storageProfile.osDisk.osType),\\r\\n    IdentityType = identity.type,\\r\\n    ComputerName = tolower(name)\\r\\n| project ComputerName, id, Location, resourceGroup, PowerStatus, OSType, IdentityType,ResourceType\\r\\n    //VM Scale Sets - Installed Extensions\\r\\n    | join kind=leftouter(\\r\\n    resources\\r\\n    | where type == \\\"microsoft.compute/virtualmachinescalesets\\\"\\r\\n    | extend ComputerName = tolower(name)\\r\\n    | mv-expand extensionProfile = properties.virtualMachineProfile.extensionProfile.extensions\\r\\n    | project ComputerName, extensionName = extensionProfile.properties.publisher\\r\\n    | extend extensionName=tostring(extensionName)\\r\\n    | summarize InstalledExtensions = make_list(extensionName) by ComputerName\\r\\n    ) on ComputerName\\r\\n)\\r\\n| union\\r\\n(\\r\\n//Azure Arc machines\\r\\nresources\\r\\n| where type == \\\"microsoft.hybridcompute/machines\\\"\\r\\n| extend PowerStatus = tostring(properties.status),\\r\\n\\tOSType = tostring(properties.osType),\\r\\n    IdentityType = identity.type,\\r\\n    ComputerName = tolower(name)\\r\\n| extend ResourceType=\\\"Azure Arc Machine\\\"\\r\\n| extend patchSettings = properties.osProfile.windowsConfiguration.patchSettings\\r\\n| extend assessmentMode = tostring(patchSettings.assessmentMode)\\r\\n| project ComputerName, id, Location, resourceGroup, PowerStatus, OSType, IdentityType,ResourceType,assessmentMode\\r\\n    //Azure Arc Machines - Installed Extensions\\r\\n    | join kind = leftouter\\r\\n    (\\r\\n    resources\\r\\n    | where type contains \\\"microsoft.hybridcompute/machines/extensions\\\"\\r\\n    | extend publisher = properties.publisher\\r\\n        | parse id with * \\\"/Microsoft.HybridCompute/machines/\\\" ComputerName \\\"/\\\" *\\r\\n        | extend extensionType = properties.type, \\r\\n            status = tostring(properties.provisioningState),\\r\\n            version = properties.typeHandlerVersion,\\r\\n            ComputerName = tolower(ComputerName)\\r\\n        | where status in (\\\"Succeeded\\\",\\\"Updating\\\")\\r\\n        | summarize InstalledExtensions = make_list(publisher) by ComputerName\\r\\n    ) on ComputerName\\r\\n    )\\r\\n    | extend AMAStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.Monitor\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend MDEStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.AzureDefenderForServers\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend CTStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.ChangeTrackingAndInventory\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend MMAStatus = case(InstalledExtensions contains \\\"Microsoft.EnterpriseCloud.Monitoring\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n    | extend DAStatus = case(InstalledExtensions contains \\\"Microsoft.Azure.Monitoring.DependencyAgent\\\", \\\"Installed\\\", \\\"Not Installed\\\")\\r\\n| extend OSType = case(OSType=~\\\"windows\\\",\\\"Windows\\\",(case(OSType=~\\\"linux\\\",\\\"Linux\\\",OSType)))\\r\\n| project ComputerName, ResourceID = tolower(id),ResourceType,Location, resourceGroup, OSType, Status=PowerStatus,AMAStatus,MMAStatus,MDEStatus, CTStatus,DAStatus,patchMode,assessmentMode\\r\\n| extend ResourceType_OS=strcat(OSType,\\\" \\\",ResourceType)\\r\\n//check to see if update manager has run in last 30 days\\r\\n| join kind=leftouter\\r\\n(\\r\\nmaintenanceresources\\r\\n| where ['type'] == \\\"microsoft.maintenance/applyupdates\\\"\\r\\n| where properties.maintenanceScope == \\\"InGuestPatch\\\"\\r\\n| extend ComputerName = tolower(tostring(split(id,'/')[8]))\\r\\n| extend StartTime = todatetime(properties.startDateTime)\\r\\n| summarize LastUpdate = max(StartTime) by ComputerName\\r\\n| extend TimeFromNow = now() - LastUpdate\\r\\n| extend DaysSinceUpdate = toint(TimeFromNow / 1d)\\r\\n| extend UpdatedRecently = case(DaysSinceUpdate<30,\\\"Yes\\\",\\\"No\\\")\\r\\n| project ComputerName,UpdatedRecently\\r\\n) on ComputerName\\r\\n//////////// EXCLUDE LIST ////////////\\r\\n//////////// EXCLUDE LIST ////////////| where ComputerName !contains \\\"EXCLUDED_COMPUTER_1\\\" and ComputerName !contains \\\"EXCLUDED_COMPUTER_1\\\"\\r\\n//////////// EXCLUDE LIST ////////////\\r\\n//////////// EXCLUDE LIST ////////////\\r\\n//////////// FILTERS ////////////\\r\\n| where (OSType in ({OSType}) and ResourceType in ({ResourceType}) and resourceGroup in ({ResourceGroup}) and Status in ({PowerStatus},\\\"\\\") and Location in ({Location}))\\r\\n//////////// FILTERS ////////////\\r\\n| project-away ComputerName,ComputerName1\\r\\n| extend bag = pack(\\\"ResourceID\\\",ResourceID,\\\"ResourceType\\\",ResourceType,\\\"ResourceType_OS\\\",ResourceType_OS,\\\"Location\\\",Location,\\\"resourceGroup\\\",resourceGroup,\\\"OSType\\\",OSType,\\\"Status\\\",Status,\\\"AMAStatus\\\",AMAStatus,\\\"MMAStatus\\\",MMAStatus,\\\"MDEStatus\\\",MDEStatus,\\\"CTStatus\\\",CTStatus,\\\"DAStatus\\\",DAStatus,\\\"patchMode\\\",patchMode,\\\"assessmentMode\\\",assessmentMode,\\\"UpdatedRecently\\\",UpdatedRecently)\\r\\n| summarize tostring(make_list(bag))\",\"crossComponentResources\":[\"{subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let arg = materialize(datatable(row:string) ['{ARGQuery}']\\r\\n| project row = todynamic(row)\\r\\n| mv-expand row\\r\\n| evaluate bag_unpack(row));\\r\\narg\\r\\n| project ResourceID,resourceGroup,Location,ResourceType,ResourceType_OS,OSType,Status,AMAStatus,DAStatus,CTStatus,MDEStatus,assessmentMode,patchMode, UpdatedRecently\\r\\n| extend MDEStatus = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",MDEStatus)\\r\\n//Exlude depedency agent from Linux\\r\\n| extend DAStatus = case(OSType==\\\"Linux\\\",\\\"n/a\\\",DAStatus)\\r\\n//Exclude Azure Update Manager from Scale Sets\\r\\n| extend assessmentMode = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",assessmentMode)\\r\\n| extend patchMode = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",patchMode)\\r\\n| extend UpdatedRecently = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",UpdatedRecently)\\r\\n| project ResourceID,resourceGroup,Location,ResourceType_OS,Status,AMAStatus,CTStatus,DAStatus,MDEStatus,assessmentMode,patchMode,UpdatedRecently\\r\\n//only show problems\\r\\n| where \\\"Show all VMs\\\" in ({ConfigurationFilter}) \\r\\nor (\\\"Show all VMs with issues\\\" in ({ConfigurationFilter}) and (AMAStatus !=\\\"Installed\\\" or CTStatus!=\\\"Installed\\\" or DAStatus!in(\\\"Installed\\\",\\\"n/a\\\") or MDEStatus!in (\\\"Installed\\\",\\\"n/a\\\") or assessmentMode!in(\\\"AutomaticByPlatform\\\",\\\"n/a\\\") or patchMode!in(\\\"Customer Managed Schedules\\\",\\\"n/a\\\") or UpdatedRecently!in(\\\"Yes\\\",\\\"n/a\\\"))) \\r\\nor (\\\"AMA Not Installed\\\" in ({ConfigurationFilter}) and AMAStatus !=\\\"Installed\\\") \\r\\nor (\\\"Dependency Agent Not Installed\\\" in ({ConfigurationFilter}) and DAStatus!in(\\\"Installed\\\",\\\"n/a\\\"))\\r\\nor (\\\"Change Tracking Extension Not Installed\\\" in ({ConfigurationFilter}) and CTStatus!=\\\"Installed\\\")\\r\\nor (\\\"MDE Extension Not Installed\\\" in ({ConfigurationFilter}) and MDEStatus!in (\\\"Installed\\\",\\\"n/a\\\"))\\r\\nor (\\\"Azure Update Manager Issues\\\" in ({ConfigurationFilter}) and (assessmentMode!=\\\"AutomaticByPlatform\\\" or patchMode!=\\\"Customer Managed Schedules\\\" or UpdatedRecently!=\\\"Yes\\\"))\\r\\n\\r\\n\",\"size\":0,\"title\":\"VM Configuration\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ResourceID\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"21ch\"}},{\"columnMatch\":\"resourceGroup\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25.1414ch\"}},{\"columnMatch\":\"Location\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"16.1409ch\"}},{\"columnMatch\":\"ResourceType_OS\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"21.2847ch\"}},{\"columnMatch\":\"Status\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"16.7143ch\"}},{\"columnMatch\":\"AMAStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"!=\",\"thresholdValue\":\"Installed\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"23.9986ch\"}},{\"columnMatch\":\"CTStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"!=\",\"thresholdValue\":\"Installed\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"19.8557ch\"}},{\"columnMatch\":\"DAStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"n/a\",\"representation\":\"more\",\"text\":\"{0}{1}\"},{\"operator\":\"!=\",\"thresholdValue\":\"Installed\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"22ch\"}},{\"columnMatch\":\"MDEStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"n/a\",\"representation\":\"more\",\"text\":\"{0}{1}\"},{\"operator\":\"!=\",\"thresholdValue\":\"Installed\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"19ch\"}},{\"columnMatch\":\"assessmentMode\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"n/a\",\"representation\":\"more\",\"text\":\"{0}{1}\"},{\"operator\":\"!=\",\"thresholdValue\":\"AutomaticByPlatform\",\"representation\":\"4\",\"text\":\"No\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"Yes\"}],\"customColumnWidthSetting\":\"22.1429ch\"}},{\"columnMatch\":\"patchMode\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"n/a\",\"representation\":\"more\",\"text\":\"{0}{1}\"},{\"operator\":\"!=\",\"thresholdValue\":\"Customer Managed Schedules\",\"representation\":\"4\",\"text\":\"No\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"Yes\"}],\"customColumnWidthSetting\":\"22.5704ch\"}},{\"columnMatch\":\"UpdatedRecently\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"n/a\",\"representation\":\"more\",\"text\":\"{0}{1}\"},{\"operator\":\"!=\",\"thresholdValue\":\"Yes\",\"representation\":\"4\",\"text\":\"No\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"22ch\"}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceID_0\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"ResourceID\",\"label\":\"Resource\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"Location\",\"label\":\"Location\"},{\"columnId\":\"ResourceType_OS\",\"label\":\"Resource Type\"},{\"columnId\":\"Status\",\"label\":\"Status\"},{\"columnId\":\"AMAStatus\",\"label\":\"Azure Monitor Agent\"},{\"columnId\":\"CTStatus\",\"label\":\"Change Tracking\"},{\"columnId\":\"DAStatus\",\"label\":\"Dependency Agent\"},{\"columnId\":\"MDEStatus\",\"label\":\"MDE Extension\"},{\"columnId\":\"assessmentMode\",\"label\":\"Update Assessment\"},{\"columnId\":\"patchMode\",\"label\":\"Update Schedule\"},{\"columnId\":\"UpdatedRecently\",\"label\":\"Updated Recently\"}]},\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceID_0\",\"sortOrder\":1}]},\"name\":\"query - 3 - Copy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let arg = materialize(datatable(row:string) ['{ARGQuery}']\\r\\n| project row = todynamic(row)\\r\\n| mv-expand row\\r\\n| evaluate bag_unpack(row));\\r\\narg\\r\\n| project ResourceID,resourceGroup,Location,ResourceType,ResourceType_OS,OSType,Status,AMAStatus,DAStatus,CTStatus,MDEStatus,assessmentMode,patchMode, UpdatedRecently\\r\\n| join kind=leftouter\\r\\n(\\r\\n//AMA Heartbeat\\r\\nHeartbeat\\r\\n| where TimeGenerated >ago(30d)\\r\\n| where Category == \\\"Azure Monitor Agent\\\"\\r\\n| where ResourceType =~ \\\"virtualMachines\\\" or ResourceType =~ \\\"virtualMachineScaleSets\\\" or ResourceType =~ \\\"machines\\\"\\r\\n| summarize LastAMAHeartbeat = arg_max(TimeGenerated,ResourceId,OSType,ResourceType,ResourceGroup,SubscriptionId) by Computer//ResourceId, Computer,OSType\\r\\n| extend ResourceId = tolower(ResourceId)\\r\\n| extend ResourceId = case(ResourceType =~ \\\"virtualMachineScaleSets\\\", split(ResourceId,\\\"/virtualmachines/\\\")[0],ResourceId)\\r\\n| extend Computer=case(ResourceType=~\\\"virtualmachinescalesets\\\",split(ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastAMAHeartbeat = arg_max(LastAMAHeartbeat,ResourceId,OSType,ResourceType,ResourceGroup,SubscriptionId) by Computer//ResourceId, Computer,OSType\\r\\n| extend ResourceType=tolower(ResourceType)\\r\\n| extend ResourceGroup = toupper(ResourceGroup)\\r\\n| extend Computer = toupper(Computer) \\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend TimeFromNow = now() - LastAMAHeartbeat\\r\\n| extend AMAHeartbeat = toint(TimeFromNow / 1s)\\r\\n| join kind=leftouter\\r\\n//VMInsights\\r\\n(\\r\\nInsightsMetrics\\r\\n| where TimeGenerated > ago(2d)\\r\\n| where Origin == \\\"vm.azm.ms\\\"\\r\\n| where Name != \\\"Heartbeat\\\"\\r\\n| summarize LastVMICollection = arg_max(TimeGenerated,*) by _ResourceId\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastVMICollection = max(LastVMICollection) by _ResourceId\\r\\n| extend TimeFromNow = now() - LastVMICollection\\r\\n| extend VMICollection = toint(TimeFromNow / 1s)\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n) on ResourceId\\r\\n| join kind=leftouter\\r\\n//Syslog\\r\\n(\\r\\nSyslog\\r\\n| where TimeGenerated > ago(2d)\\r\\n| summarize LastSyslogCollection = max(TimeGenerated) by Computer,_ResourceId\\r\\n//get Computer name from resource ID since it could be forwarding for another computer\\r\\n| extend RID_split = split(_ResourceId,\\\"/\\\")\\r\\n| extend Computer=tostring(RID_split[8])\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n//| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastSyslogCollection = max(LastSyslogCollection) by Computer,_ResourceId\\r\\n| extend TimeFromNow = now() - LastSyslogCollection\\r\\n| extend SyslogCollection = toint(TimeFromNow / 1s)\\r\\n| extend Computer = toupper(Computer)\\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n) on ResourceId\\r\\n//Sentinel Data\\r\\n| join kind=leftouter \\r\\n(\\r\\nSecurityEvent\\r\\n| where TimeGenerated > ago(2d)\\r\\n| summarize LastSecurityEventCollection = max(TimeGenerated) by Computer,_ResourceId\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastSecurityEventCollection = max(LastSecurityEventCollection) by Computer,_ResourceId\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n| extend Computer = toupper(Computer)\\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend TimeFromNow = now() - LastSecurityEventCollection\\r\\n| extend SecurityEventCollection = toint(TimeFromNow / 1s)\\r\\n) on ResourceId\\r\\n//Change Tracking data\\r\\n| join kind=leftouter\\r\\n(\\r\\nConfigurationData\\r\\n| where TimeGenerated > ago(2d)\\r\\n| summarize LastChangeTrackingEvent = max(TimeGenerated) by Computer,_ResourceId\\r\\n| extend _ResourceId = case(tolower(_ResourceId) contains \\\"virtualMachineScaleSets\\\", split(_ResourceId,\\\"/virtualmachines/\\\")[0],_ResourceId)\\r\\n| extend Computer=case(tolower(_ResourceId) contains \\\"virtualmachinescalesets\\\",split(_ResourceId,\\\"/\\\")[8],Computer)\\r\\n| summarize LastChangeTrackingEvent = max(LastChangeTrackingEvent) by Computer,_ResourceId\\r\\n| extend ResourceId = tolower(_ResourceId)\\r\\n| extend Computer = toupper(Computer)\\r\\n| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n| extend TimeFromNow = now() - LastChangeTrackingEvent\\r\\n| extend ChangeTrackingEventCollection = toint(TimeFromNow / 1s)\\r\\n) on ResourceId\\r\\n//MDE Data\\r\\n//| join kind=leftouter\\r\\n//(\\r\\n//DeviceInfo\\r\\n//| where TimeGenerated > ago(4h)\\r\\n//| where SensorHealthState ==\\\"Active\\\"\\r\\n//| where OnboardingStatus == \\\"Onboarded\\\"\\r\\n//| summarize LastDeviceInfo = max(TimeGenerated) by DeviceName\\r\\n//| extend Computer = toupper(DeviceName)\\r\\n//| extend Computer=tostring(split(Computer,\\\".\\\")[0])\\r\\n//| extend TimeFromNow = now() - LastDeviceInfo\\r\\n//| extend DeviceInfoSeconds = toint(TimeFromNow / 1s)\\r\\n//) on Computer\\r\\n//Put it all together\\r\\n//| extend MDEState = case (LastDeviceInfo>ago(4h) and ResourceType!=\\\"virtualmachinescalesets\\\",\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n//| extend MDEState = case(ResourceType==\\\"virtualmachinescalesets\\\",\\\"n/a\\\",MDEState)\\r\\n| extend AMAState = case (LastAMAHeartbeat>ago(5m),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend AMAState = case (AMAState!=\\\"Connected\\\",\\\"Not Connected\\\",AMAState)\\r\\n| extend VMInsightsState = case (LastVMICollection>ago(5m),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend SyslogState = case (LastSyslogCollection>ago(30m) and (OSType==\\\"Linux\\\"),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend SyslogState = case (OSType==\\\"Windows\\\",\\\"n/a\\\",SyslogState)\\r\\n| extend SyslogCollection = case (OSType==\\\"Windows\\\",-222,isempty(SyslogCollection),-1, SyslogCollection)\\r\\n| extend SecurityEventState = case (LastSecurityEventCollection>ago(10m) and (OSType==\\\"Windows\\\"),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n| extend SecurityEventState = case (OSType==\\\"Linux\\\",\\\"n/a\\\",SecurityEventState)\\r\\n| extend ChangeTrackingState = case (LastChangeTrackingEvent>ago(1d),\\\"Connected\\\",\\\"Not Connected\\\")\\r\\n//| project Computer,ResourceType,OSType,SubscriptionId,ResourceGroup,ResourceId,AMAState,VMInsightsState,SyslogState,SecurityEventState,ChangeTrackingState,MDEState,AMAHeartbeat,VMICollection,SyslogCollection,SecurityEventCollection,ChangeTrackingEventCollection,DeviceInfoSeconds\\r\\n| project Computer,ResourceType,OSType,SubscriptionId,ResourceGroup,ResourceId,AMAState,VMInsightsState,SyslogState,SecurityEventState,ChangeTrackingState,AMAHeartbeat,VMICollection,SyslogCollection,SecurityEventCollection,ChangeTrackingEventCollection\\r\\n| extend ResourceType = case(ResourceType==\\\"virtualmachines\\\",\\\"Virtual Machine\\\",ResourceType==\\\"virtualmachinescalesets\\\",\\\"VM Scale Set\\\",ResourceType=='machines',\\\"Azure Arc Machine\\\",ResourceType)\\r\\n| extend ResourceGroup=tolower(ResourceGroup)\\r\\n)\\r\\non $left.ResourceID == $right.ResourceId\\r\\n//| extend MDEStatus = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",MDEStatus)\\r\\n//| extend MDEState = case (isempty(MDEState),\\\"Not Connected\\\",MDEState)\\r\\n//| extend MDEState = case(ResourceType==\\\"VM Scale Set\\\",\\\"n/a\\\",MDEState)\\r\\n| extend AMAState = case (isempty(AMAState),\\\"Not Connected\\\",AMAState)\\r\\n| extend VMInsightsState = case (isempty(VMInsightsState),\\\"Not Connected\\\",VMInsightsState)\\r\\n| extend ChangeTrackingState = case (isempty(ChangeTrackingState),\\\"Not Connected\\\",ChangeTrackingState)\\r\\n| extend SyslogState = case (isempty(SyslogState),\\\"Not Connected\\\",SyslogState)\\r\\n| extend SyslogState = case (OSType==\\\"Windows\\\",\\\"n/a\\\",SyslogState)\\r\\n| extend SecurityEventState = case (isempty(SecurityEventState),\\\"Not Connected\\\",SecurityEventState)\\r\\n| extend SecurityEventState = case (OSType==\\\"Linux\\\",\\\"n/a\\\",SecurityEventState)\\r\\n\\r\\n//| project ResourceID,resourceGroup,Location,ResourceType_OS,Status,AMAHeartbeat,VMICollection,SyslogCollection,SecurityEventCollection,ChangeTrackingEventCollection,DeviceInfoSeconds,AMAState,VMInsightsState,SyslogState,SecurityEventState,ChangeTrackingState,MDEState\\r\\n| project ResourceID,resourceGroup,Location,ResourceType_OS,Status,AMAHeartbeat,VMICollection,SyslogCollection,SecurityEventCollection,ChangeTrackingEventCollection,AMAState,VMInsightsState,SyslogState,SecurityEventState,ChangeTrackingState\\r\\n| where \\\"Show all VMs\\\" in ({DataCollectionFilter}) \\r\\n//or (\\\"Show all VMs with issues\\\" in ({DataCollectionFilter}) and (AMAState ==\\\"Not Connected\\\" or VMInsightsState==\\\"Not Connected\\\" or SyslogState==\\\"Not Connected\\\" or MDEState==\\\"Not Connected\\\" or SecurityEventState==\\\"Not Connected\\\" or ChangeTrackingState == \\\"Not Connected\\\")) \\r\\nor (\\\"Show all VMs with issues\\\" in ({DataCollectionFilter}) and (AMAState ==\\\"Not Connected\\\" or VMInsightsState==\\\"Not Connected\\\" or SyslogState==\\\"Not Connected\\\" or SecurityEventState==\\\"Not Connected\\\" or ChangeTrackingState == \\\"Not Connected\\\")) \\r\\nor (\\\"No Heartbeat\\\" in ({DataCollectionFilter}) and AMAState == \\\"Not Connected\\\") \\r\\nor (\\\"No VM Insights Data\\\" in ({DataCollectionFilter}) and VMInsightsState == \\\"Not Connected\\\")\\r\\nor (\\\"No Change Tracking Data\\\" in ({DataCollectionFilter}) and ChangeTrackingState == \\\"Not Connected\\\")\\r\\nor (\\\"No Syslog Data\\\" in ({DataCollectionFilter}) and SyslogState == \\\"Not Connected\\\")\\r\\nor (\\\"No Security Events (Sentinel)\\\" in ({DataCollectionFilter}) and SecurityEventState == \\\"Not Connected\\\")\\r\\n//or (\\\"No MDE Data\\\" in ({DataCollectionFilter}) and MDEState == \\\"Not Connected\\\")\\r\\n\\r\\n\",\"size\":0,\"title\":\"Data Collection\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ResourceID\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"19.8551ch\"}},{\"columnMatch\":\"resourceGroup\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"27.2847ch\"}},{\"columnMatch\":\"Location\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"15.7123ch\"}},{\"columnMatch\":\"ResourceType_OS\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"29ch\"}},{\"columnMatch\":\"Status\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"16ch\"}},{\"columnMatch\":\"AMAHeartbeat\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"is Empty\",\"representation\":\"4\",\"text\":\"None\"},{\"sourceColumn\":\"AMAState\",\"operator\":\"==\",\"thresholdValue\":\"Not Connected\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"16.4266ch\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"VMICollection\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"is Empty\",\"representation\":\"4\",\"text\":\"None\"},{\"sourceColumn\":\"VMInsightsState\",\"operator\":\"==\",\"thresholdValue\":\"Not Connected\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"16.9996ch\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"SyslogCollection\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Windows\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"is Empty\",\"representation\":\"4\",\"text\":\"None\"},{\"sourceColumn\":\"SyslogState\",\"operator\":\"==\",\"thresholdValue\":\"Not Connected\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"sourceColumn\":\"SyslogState\",\"operator\":\"==\",\"thresholdValue\":\"n/a\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"14.5ch\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"SecurityEventCollection\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Linux\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"is Empty\",\"representation\":\"4\",\"text\":\"None\"},{\"sourceColumn\":\"SecurityEventState\",\"operator\":\"==\",\"thresholdValue\":\"Not Connected\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"18.8557ch\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"ChangeTrackingEventCollection\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"is Empty\",\"representation\":\"4\",\"text\":\"None\"},{\"sourceColumn\":\"ChangeTrackingState\",\"operator\":\"==\",\"thresholdValue\":\"Not Connected\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"19.7143ch\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"DeviceInfoSeconds\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"sourceColumn\":\"ResourceType_OS\",\"operator\":\"contains\",\"thresholdValue\":\"Scale Set\",\"representation\":\"more\",\"text\":\"n/a\"},{\"operator\":\"is Empty\",\"representation\":\"4\",\"text\":\"None\"},{\"sourceColumn\":\"MDEState\",\"operator\":\"==\",\"thresholdValue\":\"Not Connected\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"14.2837ch\"},\"numberFormat\":{\"unit\":24,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":0}}},{\"columnMatch\":\"AMAState\",\"formatter\":5},{\"columnMatch\":\"VMInsightsState\",\"formatter\":5},{\"columnMatch\":\"SyslogState\",\"formatter\":5},{\"columnMatch\":\"SecurityEventState\",\"formatter\":5},{\"columnMatch\":\"ChangeTrackingState\",\"formatter\":5},{\"columnMatch\":\"MDEState\",\"formatter\":5}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceID_0\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"ResourceID\",\"label\":\"Resource\"},{\"columnId\":\"resourceGroup\",\"label\":\"Resource Group\"},{\"columnId\":\"Location\",\"label\":\"Location\"},{\"columnId\":\"ResourceType_OS\",\"label\":\"Resource Type\"},{\"columnId\":\"Status\",\"label\":\"Status\"},{\"columnId\":\"AMAHeartbeat\",\"label\":\"Heartbeat\"},{\"columnId\":\"VMICollection\",\"label\":\"VM Insights\"},{\"columnId\":\"SyslogCollection\",\"label\":\"Syslog\"},{\"columnId\":\"SecurityEventCollection\",\"label\":\"Security Events\"},{\"columnId\":\"ChangeTrackingEventCollection\",\"label\":\"Change Tracking\"}]},\"sortBy\":[{\"itemKey\":\"$gen_link_ResourceID_0\",\"sortOrder\":1}]},\"name\":\"query - 3\",\"styleSettings\":{\"showBorder\":true}}]},\"name\":\"VMsBySubscriptionGroup\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Details-NEW\"},\"name\":\"Details-NEW Group\"}]},\"name\":\"VM_Group\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"],\"fromTemplateId\":\"community-Workbooks/Azure Monitor - Agents/Overview\"}",
                            "version": "1.0",
                            "sourceId": "Azure Monitor",
                            "category": "workbook"
                            }
                        },
                        {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "apiVersion": "2023-03-11",
                            "name": "MSVMI-DCR",
                            "Location": "[parameters('Location')]",
                            "properties": {
                                "description": "Data collection rule for VM Insights.",
                                "dataSources": {
                                    "performanceCounters": [
                                        {
                                            "streams": [
                                                "Microsoft-InsightsMetrics"
                                            ],
                                            "samplingFrequencyInSeconds": 60,
                                            "counterSpecifiers": [
                                                "\\\\VmInsights\\\\DetailedMetrics"
                                            ],
                                            "name": "VMInsightsPerfCounters"
                                        }
                                    ],
                                    "extensions": [
                                        {
                                            "streams": [
                                                "Microsoft-ServiceMap"
                                            ],
                                            "extensionName": "DependencyAgent",
                                            "extensionSettings": {},
                                            "name": "DependencyAgentDataSource"
                                        }
                                    ]
                                },
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "[parameters('LogAnalyticsWorkspaceId')]",
                                            "name": "VMInsightsPerf-Logs-Dest"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Microsoft-InsightsMetrics"
                                        ],
                                        "destinations": [
                                            "VMInsightsPerf-Logs-Dest"
                                        ]
                                    },
                                    {
                                        "streams": [
                                            "Microsoft-ServiceMap"
                                        ],
                                        "destinations": [
                                            "VMInsightsPerf-Logs-Dest"
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "apiVersion": "2023-03-11",
                            "name": "ChangeTracking-DCR",
                            "Location": "[parameters('Location')]",
                            "properties": {
                                "description": "Data collection rule for ct.",
                                "dataSources": {
                                    "extensions": [
                                        {
                                            "streams": [
                                                "Microsoft-ConfigurationChange",
                                                "Microsoft-ConfigurationChangeV2",
                                                "Microsoft-ConfigurationData"
                                            ],
                                            "extensionName": "ChangeTracking-Windows",
                                            "extensionSettings": {
                                                "enableFiles": true,
                                                "enableSoftware": true,
                                                "enableRegistry": true,
                                                "enableServices": true,
                                                "enableInventory": true,
                                                "registrySettings": {
                                                    "registryCollectionFrequency": 3000,
                                                    "registryInfo": [
                                                        {
                                                            "name": "Registry_1",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Group Policy\\Scripts\\Startup",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_2",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Group Policy\\Scripts\\Shutdown",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_3",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_4",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_5",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Classes\\Directory\\ShellEx\\ContextMenuHandlers",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_6",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Classes\\Directory\\Background\\ShellEx\\ContextMenuHandlers",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_7",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Classes\\Directory\\Shellex\\CopyHookHandlers",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_8",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellIconOverlayIdentifiers",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_9",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellIconOverlayIdentifiers",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_10",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Browser Helper Objects",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_11",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Browser Helper Objects",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_12",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Internet Explorer\\Extensions",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_13",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\Microsoft\\Internet Explorer\\Extensions",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_14",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_15",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\Software\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Drivers32",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_16",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\KnownDlls",
                                                            "valueName": ""
                                                        },
                                                        {
                                                            "name": "Registry_17",
                                                            "groupTag": "Recommended",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Notify",
                                                            "valueName": ""
                                                        }
                                                    ]
                                                },
                                                "fileSettings": {
                                                    "fileCollectionFrequency": 2700
                                                },
                                                "softwareSettings": {
                                                    "softwareCollectionFrequency": 1800
                                                },
                                                "inventorySettings": {
                                                    "inventoryCollectionFrequency": 36000
                                                },
                                                "servicesSettings": {
                                                    "serviceCollectionFrequency": 1800
                                                }
                                            },
                                            "name": "CTDataSource-Windows"
                                        },
                                        {
                                            "streams": [
                                                "Microsoft-ConfigurationChange",
                                                "Microsoft-ConfigurationChangeV2",
                                                "Microsoft-ConfigurationData"
                                            ],
                                            "extensionName": "ChangeTracking-Linux",
                                            "extensionSettings": {
                                                "enableFiles": true,
                                                "enableSoftware": true,
                                                "enableRegistry": false,
                                                "enableServices": true,
                                                "enableInventory": true,
                                                "fileSettings": {
                                                    "fileCollectionFrequency": 900,
                                                    "fileInfo": [
                                                        {
                                                            "name": "ChangeTrackingLinuxPath_default",
                                                            "enabled": true,
                                                            "destinationPath": "/etc/.*.conf",
                                                            "useSudo": true,
                                                            "recurse": true,
                                                            "maxContentsReturnable": 5000000,
                                                            "pathType": "File",
                                                            "type": "File",
                                                            "links": "Follow",
                                                            "maxOutputSize": 500000,
                                                            "groupTag": "Recommended"
                                                        }
                                                    ]
                                                },
                                                "softwareSettings": {
                                                    "softwareCollectionFrequency": 300
                                                },
                                                "inventorySettings": {
                                                    "inventoryCollectionFrequency": 36000
                                                },
                                                "servicesSettings": {
                                                    "serviceCollectionFrequency": 300
                                                }
                                            },
                                            "name": "CTDataSource-Linux"
                                        }
                                    ]
                                },
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "[parameters('LogAnalyticsWorkspaceId')]",
                                            "name": "Microsoft-CT-Dest"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Microsoft-ConfigurationChange",
                                            "Microsoft-ConfigurationChangeV2",
                                            "Microsoft-ConfigurationData"
                                        ],
                                        "destinations": [
                                            "Microsoft-CT-Dest"
                                        ]
                                    }
                                ]
                            }
                        }
                                    ]
                                }
                        }
        },
        {
        "type": "Microsoft.Authorization/policyDefinitions",
        "name": "AzMon.All.VMs.AssignUserAssignedIdentity",
        "apiVersion": "2019-09-01",
        "properties": {
        "displayName": "Azure Monitor: All VMS - Assign existing user-assigned Identity to VM",
        "policyType": "Custom",
        "mode": "Indexed",
        "description": "Copy of existing policy \"[[Preview]: Assign Built-In User-Assigned Managed Identity to Virtual Machines\". Removed options to create/use built-in identity. For this policy, an existing user-assigned identity must already be created.\n\nRoles needed:\nVirtual machine contributor\nManaged Identity Operator (must cover the identity we are associating with the VMs, plus any additional identities assigned to the VMs)",
        "metadata": {
          "category": "Monitoring"
        },
        "parameters": {
          "userAssignedIdentityName": {
            "type": "String",
            "metadata": {
              "displayName": "User-Assigned Managed Identity Name",
              "description": "The name of the pre-created user-assigned managed identity."
            },
            "defaultValue": ""
          },
          "identityResourceGroup": {
            "type": "String",
            "metadata": {
              "displayName": "User-Assigned Managed Identity Resource Group Name",
              "description": "The resource group in which the pre-created user-assigned managed identity resides."
            },
            "defaultValue": ""
          },
          "effect": {
            "type": "String",
            "metadata": {
              "displayName": "Policy Effect",
              "description": "The effect determines what happens when the policy rule is evaluated to match."
            },
            "allowedValues": [
              "AuditIfNotExists",
              "DeployIfNotExists",
              "Disabled"
            ],
            "defaultValue": "DeployIfNotExists"
          }
        },
        "policyRule": {
          "if": {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Compute/virtualMachines"
              },
              {
                "value": "[[requestContext().apiVersion]",
                "greaterOrEquals": "2018-10-01"
              }
            ]
          },
          "then": {
            "effect": "[[parameters('effect')]",
            "details": {
              "type": "Microsoft.Compute/virtualMachines",
              "name": "[[field('name')]",
              "evaluationDelay": "AfterProvisioning",
              "existenceCondition": {
                "anyOf": [
                  {
                    "allOf": [
                      {
                        "field": "identity.type",
                        "contains": "UserAssigned"
                      },
                      {
                        "field": "identity.userAssignedIdentities",
                        "containsKey": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('userAssignedIdentityName')))]"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "identity.type",
                        "equals": "UserAssigned"
                      },
                      {
                        "value": "[[string(length(field('identity.userAssignedIdentities')))]",
                        "equals": "1"
                      }
                    ]
                  }
                ]
              },
              "roleDefinitionIds": [
                "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
                "/providers/microsoft.authorization/roleDefinitions/f1a07417-d97a-45cb-824c-7a7467783830"
              ],
              "deployment": {
                "properties": {
                  "mode": "incremental",
                  "parameters": {
                    "Location": {
                      "value": "[[field('Location')]"
                    },
                    "uaName": {
                      "value": "[[parameters('userAssignedIdentityName')]"
                    },
                    "identityResourceGroup": {
                      "value": "[[parameters('identityResourceGroup')]"
                    },
                    "vmName": {
                      "value": "[[field('name')]"
                    },
                    "vmResourceGroup": {
                      "value": "[[resourceGroup().name]"
                    },
                    "resourceId": {
                      "value": "[[field('id')]"
                    }
                  },
                  "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.1",
                    "parameters": {
                      "Location": {
                        "type": "string"
                      },
                      "uaName": {
                        "type": "string"
                      },
                      "identityResourceGroup": {
                        "type": "string"
                      },
                      "vmName": {
                        "type": "string"
                      },
                      "vmResourceGroup": {
                        "type": "string"
                      },
                      "resourceId": {
                        "type": "string"
                      }
                    },
                    "variables": {
                      "uaNameWithLocation": "[[concat(parameters('uaName'),'-', parameters('Location'))]",
                      "precreatedUaId": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('uaName')))]",
                      "deployUALockName": "[[concat('deployUALock-', uniqueString(deployment().name))]",
                      "deployUAName": "[[concat('deployUA-', uniqueString(deployment().name))]",
                      "deployGetResourceProperties": "[[concat('deployGetResourceProperties-', uniqueString(deployment().name))]",
                      "deployAssignUAName": "[[concat('deployAssignUA-', uniqueString(deployment().name))]"
                    },
                    "resources": [
                      {
                        "type": "Microsoft.Resources/deployments",
                        "apiVersion": "2020-06-01",
                        "name": "[[variables('deployGetResourceProperties')]",
                        "resourceGroup": "[[parameters('vmResourceGroup')]",
                        "properties": {
                          "mode": "Incremental",
                          "template": {
                            "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "resources": [],
                            "outputs": {
                              "resource": {
                                "type": "object",
                                "value": "[[reference(parameters('resourceId'), '2019-07-01', 'Full')]"
                              }
                            }
                          }
                        }
                      },
                      {
                        "type": "Microsoft.Resources/deployments",
                        "apiVersion": "2020-06-01",
                        "name": "[[concat(variables('deployAssignUAName'))]",
                        "resourceGroup": "[[parameters('vmResourceGroup')]",
                        "dependsOn": [
                          "[[variables('deployGetResourceProperties')]"
                        ],
                        "properties": {
                          "mode": "Incremental",
                          "expressionEvaluationOptions": {
                            "scope": "inner"
                          },
                          "parameters": {
                            "uaId": {
                              "value": "[[variables('precreatedUaId')]"
                            },
                            "vmName": {
                              "value": "[[parameters('vmName')]"
                            },
                            "Location": {
                              "value": "[[parameters('Location')]"
                            },
                            "identityType": {
                              "value": "[[if(contains(reference(variables('deployGetResourceProperties')).outputs.resource.value, 'identity'), reference(variables('deployGetResourceProperties')).outputs.resource.value.identity.type, '')]"
                            },
                            "userAssignedIdentities": {
                              "value": "[[if(and(contains(reference(variables('deployGetResourceProperties')).outputs.resource.value, 'identity'), contains(reference(variables('deployGetResourceProperties')).outputs.resource.value.identity, 'userAssignedIdentities')), reference(variables('deployGetResourceProperties')).outputs.resource.value.identity.userAssignedIdentities, createObject())]"
                            }
                          },
                          "template": {
                            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {
                              "uaId": {
                                "type": "string"
                              },
                              "vmName": {
                                "type": "string"
                              },
                              "Location": {
                                "type": "string"
                              },
                              "identityType": {
                                "type": "string"
                              },
                              "userAssignedIdentities": {
                                "type": "object"
                              }
                            },
                            "variables": {
                              "identityTypeValue": "[[if(contains(parameters('identityType'), 'SystemAssigned'), 'SystemAssigned,UserAssigned', 'UserAssigned')]",
                              "userAssignedIdentitiesValue": "[[union(parameters('userAssignedIdentities'), createObject(parameters('uaId'), createObject()))]",
                              "resourceWithSingleUAI": "[[and(equals(parameters('identityType'), 'UserAssigned'), equals(string(length(parameters('userAssignedIdentities'))), '1'))]"
                            },
                            "resources": [
                              {
                                "condition": "[[not(variables('resourceWithSingleUAI'))]",
                                "apiVersion": "2019-07-01",
                                "type": "Microsoft.Compute/virtualMachines",
                                "name": "[[parameters('vmName')]",
                                "Location": "[[parameters('Location')]",
                                "identity": {
                                  "type": "[[variables('identityTypeValue')]",
                                  "userAssignedIdentities": "[[variables('userAssignedIdentitiesValue')]"
                                }
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.All.VMScaleSets.AssignUserAssignedIdentity",
            "apiVersion": "2019-09-01",
  "properties": {
    "displayName": "Azure Monitor: All VM Scale Sets - Assign existing user-assigned Identity to VM Scale Set",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Copy of existing policy. Removed options to create/use built-in identity. For this policy, an existing user-assigned identity must already be created.\n\nRoles needed:\nVirtual machine contributor\nManaged Identity Operator (must cover the identity we are associating with the VMs, plus any additional identities assigned to the VMs)",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "userAssignedIdentityName": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Name",
          "description": "The name of the pre-created user-assigned managed identity."
        },
        "defaultValue": ""
      },
      "identityResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Resource Group Name",
          "description": "The resource group in which the pre-created user-assigned managed identity resides."
        },
        "defaultValue": ""
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Policy Effect",
          "description": "The effect determines what happens when the policy rule is evaluated to match."
        },
        "allowedValues": [
          "AuditIfNotExists",
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "value": "[[requestContext().apiVersion]",
            "greaterOrEquals": "2018-10-01"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets",
          "name": "[[field('name')]",
          "evaluationDelay": "AfterProvisioning",
          "existenceCondition": {
            "anyOf": [
              {
                "allOf": [
                  {
                    "field": "identity.type",
                    "contains": "UserAssigned"
                  },
                  {
                    "field": "identity.userAssignedIdentities",
                    "containsKey": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('userAssignedIdentityName')))]"
                  }
                ]
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
            "/providers/microsoft.authorization/roleDefinitions/f1a07417-d97a-45cb-824c-7a7467783830"
          ],
          "deployment": {
            "properties": {
              "mode": "incremental",
              "parameters": {
                "Location": {
                  "value": "[[field('Location')]"
                },
                "uaName": {
                  "value": "[[parameters('userAssignedIdentityName')]"
                },
                "identityResourceGroup": {
                  "value": "[[parameters('identityResourceGroup')]"
                },
                "vmName": {
                  "value": "[[field('name')]"
                },
                "vmResourceGroup": {
                  "value": "[[resourceGroup().name]"
                },
                "resourceId": {
                  "value": "[[field('id')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.1",
                "parameters": {
                  "Location": {
                    "type": "string"
                  },
                  "uaName": {
                    "type": "string"
                  },
                  "identityResourceGroup": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "vmResourceGroup": {
                    "type": "string"
                  },
                  "resourceId": {
                    "type": "string"
                  }
                },
                "variables": {
                  "uaNameWithLocation": "[[concat(parameters('uaName'),'-', parameters('Location'))]",
                  "precreatedUaId": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('uaName')))]",
                  "deployUALockName": "[[concat('deployUALock-', uniqueString(deployment().name))]",
                  "deployUAName": "[[concat('deployUA-', uniqueString(deployment().name))]",
                  "deployGetResourceProperties": "[[concat('deployGetResourceProperties-', uniqueString(deployment().name))]",
                  "deployAssignUAName": "[[concat('deployAssignUA-', uniqueString(deployment().name))]"
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2020-06-01",
                    "name": "[[variables('deployGetResourceProperties')]",
                    "resourceGroup": "[[parameters('vmResourceGroup')]",
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "resources": [],
                        "outputs": {
                          "resource": {
                            "type": "object",
                            "value": "[[reference(parameters('resourceId'), '2019-07-01', 'Full')]"
                          }
                        }
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2020-06-01",
                    "name": "[[concat(variables('deployAssignUAName'))]",
                    "resourceGroup": "[[parameters('vmResourceGroup')]",
                    "dependsOn": [
                      "[[variables('deployGetResourceProperties')]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "uaId": {
                          "value": "[[variables('precreatedUaId')]"
                        },
                        "vmName": {
                          "value": "[[parameters('vmName')]"
                        },
                        "Location": {
                          "value": "[[parameters('Location')]"
                        },
                        "identityType": {
                          "value": "[[if(contains(reference(variables('deployGetResourceProperties')).outputs.resource.value, 'identity'), reference(variables('deployGetResourceProperties')).outputs.resource.value.identity.type, '')]"
                        },
                        "userAssignedIdentities": {
                          "value": "[[if(and(contains(reference(variables('deployGetResourceProperties')).outputs.resource.value, 'identity'), contains(reference(variables('deployGetResourceProperties')).outputs.resource.value.identity, 'userAssignedIdentities')), reference(variables('deployGetResourceProperties')).outputs.resource.value.identity.userAssignedIdentities, createObject())]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "uaId": {
                            "type": "string"
                          },
                          "vmName": {
                            "type": "string"
                          },
                          "Location": {
                            "type": "string"
                          },
                          "identityType": {
                            "type": "string"
                          },
                          "userAssignedIdentities": {
                            "type": "object"
                          }
                        },
                        "variables": {
                          "identityTypeValue": "[[if(contains(parameters('identityType'), 'SystemAssigned'), 'SystemAssigned,UserAssigned', 'UserAssigned')]",
                          "userAssignedIdentitiesValue": "[[union(parameters('userAssignedIdentities'), createObject(parameters('uaId'), createObject()))]",
                          "resourceWithSingleUAI": "[[and(equals(parameters('identityType'), 'UserAssigned'), equals(string(length(parameters('userAssignedIdentities'))), '1'))]"
                        },
                        "resources": [
                          {
                            "apiVersion": "2019-07-01",
                            "type": "Microsoft.Compute/virtualMachineScaleSets",
                            "name": "[[parameters('vmName')]",
                            "Location": "[[parameters('Location')]",
                            "identity": {
                              "type": "[[variables('identityTypeValue')]",
                              "userAssignedIdentities": "[[variables('userAssignedIdentitiesValue')]"
                            }
                          }
                        ]
                      }
                    }
                  }
                ]
              }
            }
          }
        }
      }
    }
  }
  },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VM.AzureMonitorAgent.SystemAssignedIdentity",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VMs - Azure Monitor Agent - System-assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfLinuxImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "field": "identity.type",
            "contains": "SystemAssigned"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfLinuxImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-ARM64",
                      "RHEL-BYOS",
                      "RHEL-HA",
                      "RHEL-SAP",
                      "RHEL-SAP-APPS",
                      "RHEL-SAP-HA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSku",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "UbuntuServer"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-server-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-pro-*"
                      }
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "14.04.0-lts",
                      "14.04.1-lts",
                      "14.04.2-lts",
                      "14.04.3-lts",
                      "14.04.4-lts",
                      "14.04.5-lts",
                      "16_04_0-lts-gen2",
                      "16_04-lts-gen2",
                      "16.04-lts",
                      "16.04.0-lts",
                      "18_04-lts-arm64",
                      "18_04-lts-gen2",
                      "18.04-lts",
                      "20_04-lts-arm64",
                      "20_04-lts-gen2",
                      "20_04-lts",
                      "22_04-lts-gen2",
                      "22_04-lts",
                      "pro-16_04-lts-gen2",
                      "pro-16_04-lts",
                      "pro-18_04-lts-gen2",
                      "pro-18_04-lts",
                      "pro-20_04-lts-gen2",
                      "pro-20_04-lts",
                      "pro-22_04-lts-gen2",
                      "pro-22_04-lts"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "7*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "ctrliqinc1648673227698"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "rocky-8*"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "rocky-8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "Debian"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "equals": "9"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Debian"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian-10",
                      "debian-11"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "10",
                      "10-gen2",
                      "11",
                      "11-gen2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoftcblmariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cbl-mariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "1-gen2",
                      "cbl-mariner-1",
                      "cbl-mariner-2",
                      "cbl-mariner-2-arm64",
                      "cbl-mariner-2-gen2"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "AzureMonitorLinuxAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorLinuxAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionTypeHandlerVersion": "1.27",
                  "extensionType": "AzureMonitorLinuxAgent"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
  },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VM.AzureMonitorAgent.UserAssignedIdentity",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VMs - Azure Monitor Agent - User Assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Automate the deployment of Azure Monitor Agent extension on your Linux virtual machines for collecting telemetry data from the guest OS. This policy will install the extension and configure it to use the specified user-assigned managed identity if the OS and region are supported, and skip install otherwise. Learn more: https://aka.ms/AMAOverview.",
    "metadata": {
      "version": "3.5.0",
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "bringYourOwnUserAssignedManagedIdentity": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Bring Your Own User-Assigned Managed Identity",
          "description": "If set to true, Azure Monitor Agent will use the user-assigned managed identity specified via the 'User-Assigned Managed Identity ...' parameters for authentication. Otherwise, Azure Monitor Agent will use the user-assigned managed identity /subscriptions/<subscription-id>/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-<Location> for authentication."
        },
        "allowedValues": [
          false,
          true
        ]
      },
      "userAssignedManagedIdentityName": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Name",
          "description": "The name of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "userAssignedManagedIdentityResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Resource Group",
          "description": "The resource group of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfLinuxImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfLinuxImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-ARM64",
                      "RHEL-BYOS",
                      "RHEL-HA",
                      "RHEL-SAP",
                      "RHEL-SAP-APPS",
                      "RHEL-SAP-HA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSku",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "UbuntuServer"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-server-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-pro-*"
                      }
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "14.04.0-lts",
                      "14.04.1-lts",
                      "14.04.2-lts",
                      "14.04.3-lts",
                      "14.04.4-lts",
                      "14.04.5-lts",
                      "16_04_0-lts-gen2",
                      "16_04-lts-gen2",
                      "16.04-lts",
                      "16.04.0-lts",
                      "18_04-lts-arm64",
                      "18_04-lts-gen2",
                      "18.04-lts",
                      "20_04-lts-arm64",
                      "20_04-lts-gen2",
                      "20_04-lts",
                      "22_04-lts-gen2",
                      "22_04-lts",
                      "pro-16_04-lts-gen2",
                      "pro-16_04-lts",
                      "pro-18_04-lts-gen2",
                      "pro-18_04-lts",
                      "pro-20_04-lts-gen2",
                      "pro-20_04-lts",
                      "pro-22_04-lts-gen2",
                      "pro-22_04-lts"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "7*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "ctrliqinc1648673227698"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "rocky-8*"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "rocky-8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "Debian"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "equals": "9"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Debian"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian-10",
                      "debian-11"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "10",
                      "10-gen2",
                      "11",
                      "11-gen2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoftcblmariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cbl-mariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "1-gen2",
                      "cbl-mariner-1",
                      "cbl-mariner-2",
                      "cbl-mariner-2-arm64",
                      "cbl-mariner-2-gen2"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "AzureMonitorLinuxAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "userAssignedManagedIdentity": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorLinuxAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionTypeHandlerVersion": "1.29",
                  "extensionType": "AzureMonitorLinuxAgent"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {
                        "authentication": {
                          "managedIdentity": {
                            "identifier-name": "mi_res_id",
                            "identifier-value": "[[parameters('userAssignedManagedIdentity')]"
                          }
                        }
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "userAssignedManagedIdentity": {
                  "value": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('userAssignedManagedIdentityResourceGroup'), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', parameters('userAssignedManagedIdentityName')), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-', field('Location')))]"
                }
              }
            }
          }
        }
      }
    }
  }
  },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VM.DCRa",
            "apiVersion": "2019-09-01",
            "properties": {
            "displayName": "Azure Monitor: Linux VMs - Data Collection Rule Association",
            "policyType": "Custom",
            "mode": "Indexed",
            "description": "Copy of existing policy, modified to include \"scope only to supported OS\" parameter",
            "metadata": {
                "category": "Monitoring",
                "createdBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
                "createdOn": "2024-02-15T16:23:52.9873602Z",
                "updatedBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
                "updatedOn": "2024-02-27T16:07:37.0839939Z"
            },
            "parameters": {
                "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy."
                },
                "allowedValues": [
                    "DeployIfNotExists",
                    "Disabled"
                ],
                "defaultValue": "DeployIfNotExists"
                },
                "scopeToSupportedImages": {
                "type": "Boolean",
                "metadata": {
                    "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
                    "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
                },
                "allowedValues": [
                    true,
                    false
                ],
                "defaultValue": true
                },
                "listOfLinuxImageIdToInclude": {
                "type": "Array",
                "metadata": {
                    "displayName": "Additional Linux Machine Images",
                    "description": "List of machine images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
                },
                "defaultValue": []
                },
                "dcrResourceId": {
                "type": "String",
                "metadata": {
                    "displayName": "Data Collection Rule Resource Id or Data Collection Endpoint Resource Id",
                    "description": "Resource Id of the Data Collection Rule or the Data Collection Endpoint to be applied on the Linux machines in scope.",
                    "portalReview": "true"
                }
                },
                "resourceType": {
                "type": "String",
                "metadata": {
                    "displayName": "Resource Type",
                    "description": "Either a Data Collection Rule (DCR) or a Data Collection Endpoint (DCE)",
                    "portalReview": "true"
                },
                "allowedValues": [
                    "Microsoft.Insights/dataCollectionRules",
                    "Microsoft.Insights/dataCollectionEndpoints"
                ],
                "defaultValue": "Microsoft.Insights/dataCollectionRules"
                }
            },
            "policyRule": {
                "if": {
                "allOf": [
                    {
                    "field": "type",
                    "equals": "Microsoft.Compute/virtualMachines"
                    },
                    {
                    "anyOf": [
                        {
                        "allOf": [
                            {
                            "value": "[[parameters('scopeToSupportedImages')]",
                            "equals": false
                            },
                            {
                            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                            "like": "Linux*"
                            }
                        ]
                        },
                        {
                        "field": "Microsoft.Compute/imageId",
                        "in": "[[parameters('listOfLinuxImageIdToInclude')]"
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "RedHat"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                                "RHEL",
                                "RHEL-SAP-HANA"
                            ]
                            },
                            {
                            "anyOf": [
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "6*"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "7*"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "8*"
                                }
                            ]
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "SUSE"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                                "SLES",
                                "SLES-HPC",
                                "SLES-HPC-Priority",
                                "SLES-SAP",
                                "SLES-SAP-BYOS",
                                "SLES-Priority",
                                "SLES-BYOS",
                                "SLES-SAPCAL",
                                "SLES-Standard"
                            ]
                            },
                            {
                            "anyOf": [
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "12*"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "15*"
                                }
                            ]
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "Canonical"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "equals": "UbuntuServer"
                            },
                            {
                            "anyOf": [
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "14.04*LTS"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "16.04*LTS"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "18.04*LTS"
                                }
                            ]
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "Canonical"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "equals": "0001-com-ubuntu-server-focal"
                            },
                            {
                            "anyOf": [
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "20_04-lts*"
                                }
                            ]
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "Oracle"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "equals": "Oracle-Linux"
                            },
                            {
                            "anyOf": [
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "6*"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "7*"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "8*"
                                }
                            ]
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "OpenLogic"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                                "CentOS",
                                "Centos-LVM",
                                "CentOS-SRIOV"
                            ]
                            },
                            {
                            "anyOf": [
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "6*"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "7*"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "8*"
                                }
                            ]
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "cloudera"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "equals": "cloudera-centos-os"
                            },
                            {
                            "field": "Microsoft.Compute/imageSku",
                            "like": "7*"
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "credativ"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                                "debian"
                            ]
                            },
                            {
                            "anyOf": [
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "8"
                                },
                                {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "9"
                                }
                            ]
                            }
                        ]
                        },
                        {
                        "allOf": [
                            {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "Debian"
                            },
                            {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                                "debian-10"
                            ]
                            },
                            {
                            "field": "Microsoft.Compute/imageSku",
                            "like": "10"
                            }
                        ]
                        }
                    ]
                    }
                ]
                },
                "then": {
                "effect": "[[parameters('effect')]",
                "details": {
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "roleDefinitionIds": [
                    "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
                    "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
                    ],
                    "evaluationDelay": "AfterProvisioning",
                    "existenceCondition": {
                    "anyOf": [
                        {
                        "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionRuleId",
                        "equals": "[[parameters('dcrResourceId')]"
                        },
                        {
                        "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionEndpointId",
                        "equals": "[[parameters('dcrResourceId')]"
                        }
                    ]
                    },
                    "deployment": {
                    "properties": {
                        "mode": "incremental",
                        "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                            "resourceName": {
                            "type": "string"
                            },
                            "Location": {
                            "type": "string"
                            },
                            "dcrResourceId": {
                            "type": "string"
                            },
                            "resourceType": {
                            "type": "string"
                            }
                        },
                        "variables": {
                            "dcrAssociationName": "[[concat('assoc-', uniqueString(concat(parameters('resourceName'), parameters('dcrResourceId'))))]",
                            "dceAssociationName": "configurationAccessEndpoint",
                            "dcrResourceType": "Microsoft.Insights/dataCollectionRules",
                            "dceResourceType": "Microsoft.Insights/dataCollectionEndpoints"
                        },
                        "resources": [
                            {
                            "condition": "[[equals(parameters('resourceType'), variables('dcrResourceType'))]",
                            "name": "[[variables('dcrAssociationName')]",
                            "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                            "apiVersion": "2021-04-01",
                            "properties": {
                                "dataCollectionRuleId": "[[parameters('dcrResourceId')]"
                            },
                            "scope": "[[concat('Microsoft.Compute/virtualMachines/', parameters('resourceName'))]"
                            },
                            {
                            "condition": "[[equals(parameters('resourceType'), variables('dceResourceType'))]",
                            "name": "[[variables('dceAssociationName')]",
                            "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                            "apiVersion": "2021-04-01",
                            "properties": {
                                "dataCollectionEndpointId": "[[parameters('dcrResourceId')]"
                            },
                            "scope": "[[concat('Microsoft.Compute/virtualMachines/', parameters('resourceName'))]"
                            }
                        ]
                        },
                        "parameters": {
                        "resourceName": {
                            "value": "[[field('name')]"
                        },
                        "Location": {
                            "value": "[[field('Location')]"
                        },
                        "dcrResourceId": {
                            "value": "[[parameters('dcrResourceId')]"
                        },
                        "resourceType": {
                            "value": "[[parameters('resourceType')]"
                        }
                        }
                    }
                    }
                }
                }
            }
            }
      },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VM.DependencyAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VMs - Dependency Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Deploy Dependency agent for Linux virtual machines with Azure Monitoring Agent settings if the VM Image (OS) is in the list defined and the agent is not installed.",
    "metadata": {
      "version": "3.1.1",
      "category": "Monitoring"
    },
    "parameters": {
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of VM images that have supported Linux OS to add to scope",
          "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "enableProcessesAndDependencies": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Enable Processes and Dependencies",
          "description": "This is the flag for enabling processes and dependencies data collection in VMInsights. If you are using this standalone policy and what to install Dependency Agent, keep this value as true."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Dependency Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://learn.microsoft.com/en-us/azure/azure-monitor/vm/vminsights-dependency-agent-maintenance"
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "value": "[[parameters('enableProcessesAndDependencies')]",
            "equals": true
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "UbuntuServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "in": [
                          "14.04.0-LTS",
                          "14.04.1-LTS",
                          "14.04.5-LTS"
                        ]
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "in": [
                          "16.04-LTS",
                          "16.04.0-LTS"
                        ]
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "in": [
                          "18.04-LTS"
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "0001-com-ubuntu-server-focal"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "20_04-lts"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-SAP-HANA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "in": [
                                  "12-SP2",
                                  "12-SP3",
                                  "12-SP4",
                                  "12-sp4-gen2",
                                  "12-SP5",
                                  "15",
                                  "15-SP1"
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12-sp5*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15-sp1*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSKU",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "like": "sles-sap-15-sp1*"
                          },
                          {
                            "field": "Microsoft.Compute/imageSKU",
                            "equals": "gen1"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "like": "7*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "DependencyAgentLinux"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.Monitoring.DependencyAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "DependencyAgentLinux",
                  "vmExtensionPublisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                  "vmExtensionType": "DependencyAgentLinux",
                  "vmExtensionTypeHandlerVersion": "9.10"
                },
                "resources": [
                  {
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "apiVersion": "2021-04-01",
                    "Location": "[[parameters('Location')]",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "enableAMA": "true"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for VM', ': ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VM.LogAnalyticsAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VMs - Log Analytics Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring",
      "createdBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
      "createdOn": "2024-02-27T16:00:44.0804719Z",
      "updatedBy": null,
      "updatedOn": null
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace",
          "assignPermissions": true
        }
      },
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of VM images that have supported Linux OS to add to scope",
          "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-SAP-HANA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12-sp*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15-sp*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-sap-15-sp1*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSKU",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "UbuntuServer",
                      "0001-com-ubuntu-server-focal"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "14.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "16.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "16_04*lts-gen2"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "18.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "18_04*lts-gen2"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "20_04*lts"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "20_04*lts-gen2"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Debian"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "9*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7.*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "like": "7*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "deployIfNotExists",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "OmsAgentForLinux"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.EnterpriseCloud.Monitoring"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "logAnalytics": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "OMSAgentForLinux",
                  "vmExtensionPublisher": "Microsoft.EnterpriseCloud.Monitoring",
                  "vmExtensionType": "OmsAgentForLinux",
                  "vmExtensionTypeHandlerVersion": "1.13"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2018-06-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "workspaceId": "[[reference(parameters('logAnalytics'), '2015-03-20').customerId]",
                        "stopOnMultipleConnections": "true"
                      },
                      "protectedSettings": {
                        "workspaceKey": "[[listKeys(parameters('logAnalytics'), '2015-03-20').primarySharedKey]"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for VM', ': ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VMScaleSet.AzureMonitorAgent.SystemAssignedIdentity",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VM Scale Sets - Azure Monitor Agent - System-assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfLinuxImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "field": "identity.type",
            "contains": "SystemAssigned"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfLinuxImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-ARM64",
                      "RHEL-BYOS",
                      "RHEL-HA",
                      "RHEL-SAP",
                      "RHEL-SAP-APPS",
                      "RHEL-SAP-HA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSku",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "UbuntuServer"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-server-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-pro-*"
                      }
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "14.04.0-lts",
                      "14.04.1-lts",
                      "14.04.2-lts",
                      "14.04.3-lts",
                      "14.04.4-lts",
                      "14.04.5-lts",
                      "16_04_0-lts-gen2",
                      "16_04-lts-gen2",
                      "16.04-lts",
                      "16.04.0-lts",
                      "18_04-lts-arm64",
                      "18_04-lts-gen2",
                      "18.04-lts",
                      "20_04-lts-arm64",
                      "20_04-lts-gen2",
                      "20_04-lts",
                      "22_04-lts-gen2",
                      "22_04-lts",
                      "pro-16_04-lts-gen2",
                      "pro-16_04-lts",
                      "pro-18_04-lts-gen2",
                      "pro-18_04-lts",
                      "pro-20_04-lts-gen2",
                      "pro-20_04-lts",
                      "pro-22_04-lts-gen2",
                      "pro-22_04-lts"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "7*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "ctrliqinc1648673227698"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "rocky-8*"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "rocky-8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "Debian"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "equals": "9"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Debian"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian-10",
                      "debian-11"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "10",
                      "10-gen2",
                      "11",
                      "11-gen2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoftcblmariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cbl-mariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "1-gen2",
                      "cbl-mariner-1",
                      "cbl-mariner-2",
                      "cbl-mariner-2-arm64",
                      "cbl-mariner-2-gen2"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "AzureMonitorLinuxAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorLinuxAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionTypeHandlerVersion": "1.29",
                  "extensionType": "AzureMonitorLinuxAgent"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VMScaleSet.AzureMonitorAgent.UserAssignedIdentity",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VM Scale Sets - Azure Monitor Agent - User Assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Automate the deployment of Azure Monitor Agent extension on your Linux virtual machine scale sets for collecting telemetry data from the guest OS. This policy will install the extension and configure it to use the specified user-assigned managed identity if the OS and region are supported, and skip install otherwise. Learn more: https://aka.ms/AMAOverview.",
    "metadata": {
      "version": "3.5.0",
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "bringYourOwnUserAssignedManagedIdentity": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Bring Your Own User-Assigned Managed Identity",
          "description": "If set to true, Azure Monitor Agent will use the user-assigned managed identity specified via the 'User-Assigned Managed Identity ...' parameters for authentication. Otherwise, Azure Monitor Agent will use the user-assigned managed identity /subscriptions/<subscription-id>/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-<Location> for authentication."
        },
        "allowedValues": [
          false,
          true
        ]
      },
      "userAssignedManagedIdentityName": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Name",
          "description": "The name of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "userAssignedManagedIdentityResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Resource Group",
          "description": "The resource group of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfLinuxImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfLinuxImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-ARM64",
                      "RHEL-BYOS",
                      "RHEL-HA",
                      "RHEL-SAP",
                      "RHEL-SAP-APPS",
                      "RHEL-SAP-HA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSku",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "UbuntuServer"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-server-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-pro-*"
                      }
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "14.04.0-lts",
                      "14.04.1-lts",
                      "14.04.2-lts",
                      "14.04.3-lts",
                      "14.04.4-lts",
                      "14.04.5-lts",
                      "16_04_0-lts-gen2",
                      "16_04-lts-gen2",
                      "16.04-lts",
                      "16.04.0-lts",
                      "18_04-lts-arm64",
                      "18_04-lts-gen2",
                      "18.04-lts",
                      "20_04-lts-arm64",
                      "20_04-lts-gen2",
                      "20_04-lts",
                      "22_04-lts-gen2",
                      "22_04-lts",
                      "pro-16_04-lts-gen2",
                      "pro-16_04-lts",
                      "pro-18_04-lts-gen2",
                      "pro-18_04-lts",
                      "pro-20_04-lts-gen2",
                      "pro-20_04-lts",
                      "pro-22_04-lts-gen2",
                      "pro-22_04-lts"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "7*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "ctrliqinc1648673227698"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "rocky-8*"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "rocky-8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "Debian"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "equals": "9"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Debian"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian-10",
                      "debian-11"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "10",
                      "10-gen2",
                      "11",
                      "11-gen2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoftcblmariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cbl-mariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "1-gen2",
                      "cbl-mariner-1",
                      "cbl-mariner-2",
                      "cbl-mariner-2-arm64",
                      "cbl-mariner-2-gen2"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "AzureMonitorLinuxAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "userAssignedManagedIdentity": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorLinuxAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionTypeHandlerVersion": "1.29",
                  "extensionType": "AzureMonitorLinuxAgent"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "autoUpgradeMinorVersion": true,
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "enableAutomaticUpgrade": true,
                      "settings": {
                        "authentication": {
                          "managedIdentity": {
                            "identifier-name": "mi_res_id",
                            "identifier-value": "[[parameters('userAssignedManagedIdentity')]"
                          }
                        }
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "userAssignedManagedIdentity": {
                  "value": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('userAssignedManagedIdentityResourceGroup'), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', parameters('userAssignedManagedIdentityName')), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-', field('Location')))]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VMScaleSet.DCRa",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VM Scale Set - Data Collection Rule Association",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Copy of existing policy, modified to include \"scope only to supported OS\" parameter",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfLinuxImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Linux Machine Images",
          "description": "List of virtual machine scale set images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "dcrResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Resource Id or Data Collection Endpoint Resource Id",
          "description": "Resource Id of the Data Collection Rule or the Data Collection Endpoint to be applied on the Linux machines in scope.",
          "portalReview": "true"
        }
      },
      "resourceType": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Type",
          "description": "Either a Data Collection Rule (DCR) or a Data Collection Endpoint (DCE)",
          "portalReview": "true"
        },
        "allowedValues": [
          "Microsoft.Insights/dataCollectionRules",
          "Microsoft.Insights/dataCollectionEndpoints"
        ],
        "defaultValue": "Microsoft.Insights/dataCollectionRules"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfLinuxImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-SAP-HANA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "SLES",
                      "SLES-HPC",
                      "SLES-HPC-Priority",
                      "SLES-SAP",
                      "SLES-SAP-BYOS",
                      "SLES-Priority",
                      "SLES-BYOS",
                      "SLES-SAPCAL",
                      "SLES-Standard"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "12*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "15*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "UbuntuServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "14.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "16.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "18.04*LTS"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "0001-com-ubuntu-server-focal"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "20_04-lts*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "7*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "9"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Debian"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian-10"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "10"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "evaluationDelay": "AfterProvisioning",
          "existenceCondition": {
            "anyOf": [
              {
                "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionRuleId",
                "equals": "[[parameters('dcrResourceId')]"
              },
              {
                "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionEndpointId",
                "equals": "[[parameters('dcrResourceId')]"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "dcrResourceId": {
                    "type": "string"
                  },
                  "resourceType": {
                    "type": "string"
                  }
                },
                "variables": {
                  "dcrAssociationName": "[[concat('assoc-', uniqueString(concat(parameters('resourceName'), parameters('dcrResourceId'))))]",
                  "dceAssociationName": "configurationAccessEndpoint",
                  "dcrResourceType": "Microsoft.Insights/dataCollectionRules",
                  "dceResourceType": "Microsoft.Insights/dataCollectionEndpoints"
                },
                "resources": [
                  {
                    "condition": "[[equals(parameters('resourceType'), variables('dcrResourceType'))]",
                    "name": "[[variables('dcrAssociationName')]",
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "dataCollectionRuleId": "[[parameters('dcRresourceId')]"
                    },
                    "scope": "[[concat('Microsoft.Compute/virtualMachineScaleSets/', parameters('resourceName'))]"
                  },
                  {
                    "condition": "[[equals(parameters('resourceType'), variables('dceResourceType'))]",
                    "name": "[[variables('dceAssociationName')]",
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "dataCollectionEndpointId": "[[parameters('dcrResourceId')]"
                    },
                    "scope": "[[concat('Microsoft.Compute/virtualMachineScaleSets/', parameters('resourceName'))]"
                  }
                ]
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "dcrResourceId": {
                  "value": "[[parameters('dcrResourceId')]"
                },
                "resourceType": {
                  "value": "[[parameters('resourceType')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VMScaleSet.DependencyAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VM Scale Sets - Dependency Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Deploy Dependency agent for Linux virtual machine scale sets with Azure Monitoring Agent settings if the VM Image (OS) is in the list defined and the agent is not installed. Note: if your scale set upgradePolicy is set to Manual, you need to apply the extension to the all virtual machines in the set by calling upgrade on them. In CLI this would be az vmss update-instances.",
    "metadata": {
      "version": "3.1.1",
      "category": "Monitoring"
    },
    "parameters": {
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of VM images that have supported Linux OS to add to scope",
          "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "enableProcessesAndDependencies": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Enable Processes and Dependencies",
          "description": "This is the flag for enabling processes and dependencies data collection in VMInsights. If you are using this standalone policy and what to install Dependency Agent, keep this value as true."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Dependency Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://learn.microsoft.com/en-us/azure/azure-monitor/vm/vminsights-dependency-agent-maintenance"
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "value": "[[parameters('enableProcessesAndDependencies')]",
            "equals": true
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "UbuntuServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "in": [
                          "14.04.0-LTS",
                          "14.04.1-LTS",
                          "14.04.5-LTS"
                        ]
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "in": [
                          "16.04-LTS",
                          "16.04.0-LTS"
                        ]
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "in": [
                          "18.04-LTS"
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "0001-com-ubuntu-server-focal"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "20_04-lts"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-SAP-HANA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "in": [
                                  "12-SP2",
                                  "12-SP3",
                                  "12-SP4",
                                  "12-sp4-gen2",
                                  "12-SP5",
                                  "15",
                                  "15-SP1"
                                ]
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12-sp5*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15-sp1*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSKU",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "like": "sles-sap-15-sp1*"
                          },
                          {
                            "field": "Microsoft.Compute/imageSKU",
                            "equals": "gen1"
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "like": "7*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "DependencyAgentLinux"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.Azure.Monitoring.DependencyAgent"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "DependencyAgentLinux",
                  "vmExtensionPublisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                  "vmExtensionType": "DependencyAgentLinux",
                  "vmExtensionTypeHandlerVersion": "9.10"
                },
                "resources": [
                  {
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "apiVersion": "2021-04-01",
                    "Location": "[[parameters('Location')]",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "enableAMA": "true"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for: ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VMScaleSet.LogAnalyticsAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VM Scale Sets - Log Analytics Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring",
      "createdBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
      "createdOn": "2024-02-27T18:33:04.0109848Z",
      "updatedBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
      "updatedOn": "2024-02-27T19:29:27.9785011Z"
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace",
          "assignPermissions": true
        }
      },
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of VM images that have supported Linux OS to add to scope",
          "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-SAP-HANA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12-sp*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15-sp*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-sap-15-sp1*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSKU",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "UbuntuServer",
                      "0001-com-ubuntu-server-focal"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "14.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "16.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "16_04*lts-gen2"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "18.04*LTS"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "18_04*lts-gen2"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "20_04*lts"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "20_04*lts-gen2"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Debian"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "9*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7.*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "6.*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSKU",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "like": "7*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "deployIfNotExists",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293",
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "OmsAgentForLinux"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.EnterpriseCloud.Monitoring"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "logAnalytics": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "OMSAgentForLinux",
                  "vmExtensionPublisher": "Microsoft.EnterpriseCloud.Monitoring",
                  "vmExtensionType": "OmsAgentForLinux",
                  "vmExtensionTypeHandlerVersion": "1.13"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2018-06-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "workspaceId": "[[reference(parameters('logAnalytics'), '2015-03-20').customerId]",
                        "stopOnMultipleConnections": "true"
                      },
                      "protectedSettings": {
                        "workspaceKey": "[[listKeys(parameters('logAnalytics'), '2015-03-20').primarySharedKey]"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for: ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VM.AzureMonitorAgent.SystemAssignedIdentity",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VMs - Azure Monitor Agent - System-assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "createdBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
      "createdOn": "2024-02-07T23:20:42.9828197Z",
      "updatedBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
      "updatedOn": "2024-02-07T23:22:03.0508267Z",
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2008-R2-SP1*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2012-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2016-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2019-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2022-*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          },
          {
            "field": "identity.type",
            "contains": "SystemAssigned"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "AzureMonitorWindowsAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorWindowsAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionType": "AzureMonitorWindowsAgent",
                  "extensionTypeHandlerVersion": "1.1"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VM.AzureMonitorAgent.UserAssignedIdentity",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VMs - Azure Monitor Agent - User Assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Automate the deployment of Azure Monitor Agent extension on your Windows virtual machines for collecting telemetry data from the guest OS. This policy will install the extension and configure it to use the specified user-assigned managed identity if the OS and region are supported, and skip install otherwise. Learn more: https://aka.ms/AMAOverview.",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "bringYourOwnUserAssignedManagedIdentity": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Bring Your Own User-Assigned Managed Identity",
          "description": "If set to true, Azure Monitor Agent will use the user-assigned managed identity specified via the 'User-Assigned Managed Identity ...' parameters for authentication. Otherwise, Azure Monitor Agent will use the user-assigned managed identity /subscriptions/<subscription-id>/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-<Location> for authentication."
        },
        "allowedValues": [
          false,
          true
        ]
      },
      "userAssignedManagedIdentityName": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Name",
          "description": "The name of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "userAssignedManagedIdentityResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Resource Group",
          "description": "The resource group of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2008-R2-SP1*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2012-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2016-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2019-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2022-*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "AzureMonitorWindowsAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "userAssignedManagedIdentity": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorWindowsAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionType": "AzureMonitorWindowsAgent",
                  "extensionTypeHandlerVersion": "1.2"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {
                        "authentication": {
                          "managedIdentity": {
                            "identifier-name": "mi_res_id",
                            "identifier-value": "[[parameters('userAssignedManagedIdentity')]"
                          }
                        }
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "userAssignedManagedIdentity": {
                  "value": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('userAssignedManagedIdentityResourceGroup'), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', parameters('userAssignedManagedIdentityName')), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-', field('Location')))]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VM.DCRa",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VMs - Data Collection Rule Association",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Copy of existing policy, modified to include \"scope only to supported OS\" parameter",
    "metadata": {
      "category": "Monitoring",
      "createdBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
      "createdOn": "2024-02-15T04:00:21.283775Z",
      "updatedBy": "6b6cfcd1-e801-4993-8a94-2ea58e051a41",
      "updatedOn": "2024-02-27T16:05:11.4802188Z"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of virtual machine images that have supported Windows OS to add to scope",
          "description": "Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "dcrResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Resource Id or Data Collection Endpoint Resource Id",
          "description": "Resource Id of the Data Collection Rule or the Data Collection Endpoint to be applied on the Linux machines in scope.",
          "portalReview": "true"
        }
      },
      "resourceType": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Type",
          "description": "Either a Data Collection Rule (DCR) or a Data Collection Endpoint (DCE)",
          "portalReview": "true"
        },
        "allowedValues": [
          "Microsoft.Insights/dataCollectionRules",
          "Microsoft.Insights/dataCollectionEndpoints"
        ],
        "defaultValue": "Microsoft.Insights/dataCollectionRules"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "2008-R2-SP1",
                      "2008-R2-SP1-smalldisk",
                      "2012-Datacenter",
                      "2012-Datacenter-smalldisk",
                      "2012-R2-Datacenter",
                      "2012-R2-Datacenter-smalldisk",
                      "2016-Datacenter",
                      "2016-Datacenter-Server-Core",
                      "2016-Datacenter-Server-Core-smalldisk",
                      "2016-Datacenter-smalldisk",
                      "2016-Datacenter-with-Containers",
                      "2016-Datacenter-with-RDSH",
                      "2016-datacenter-gensecond",
                      "2019-Datacenter",
                      "2019-Datacenter-Core",
                      "2019-Datacenter-Core-smalldisk",
                      "2019-Datacenter-Core-with-Containers",
                      "2019-Datacenter-Core-with-Containers-smalldisk",
                      "2019-Datacenter-smalldisk",
                      "2019-Datacenter-with-Containers",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-gensecond",
                      "2022-datacenter",
                      "2022-datacenter-azure-edition",
                      "2022-datacenter-azure-edition-core",
                      "2022-datacenter-azure-edition-core-smalldisk",
                      "2022-datacenter-azure-edition-smalldisk",
                      "2022-datacenter-core",
                      "2022-datacenter-core-g2",
                      "2022-datacenter-core-smalldisk",
                      "2022-datacenter-core-smalldisk-g2",
                      "2022-datacenter-g2",
                      "2022-datacenter-smalldisk",
                      "2022-datacenter-smalldisk-g2",
                      "2022-datacenter-gensecond"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "evaluationDelay": "AfterProvisioning",
          "existenceCondition": {
            "anyOf": [
              {
                "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionRuleId",
                "equals": "[[parameters('dcrResourceId')]"
              },
              {
                "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionEndpointId",
                "equals": "[[parameters('dcrResourceId')]"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "dcrResourceId": {
                    "type": "string"
                  },
                  "resourceType": {
                    "type": "string"
                  }
                },
                "variables": {
                  "dcrAssociationName": "[[concat('assoc-', uniqueString(concat(parameters('resourceName'), parameters('dcrResourceId'))))]",
                  "dceAssociationName": "configurationAccessEndpoint",
                  "dcrResourceType": "Microsoft.Insights/dataCollectionRules",
                  "dceResourceType": "Microsoft.Insights/dataCollectionEndpoints"
                },
                "resources": [
                  {
                    "condition": "[[equals(parameters('resourceType'), variables('dcrResourceType'))]",
                    "name": "[[variables('dcrAssociationName')]",
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "dataCollectionRuleId": "[[parameters('dcrResourceId')]"
                    },
                    "scope": "[[concat('Microsoft.Compute/virtualMachines/', parameters('resourceName'))]"
                  },
                  {
                    "condition": "[[equals(parameters('resourceType'), variables('dceResourceType'))]",
                    "name": "[[variables('dceAssociationName')]",
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "dataCollectionEndpointId": "[[parameters('dcrResourceId')]"
                    },
                    "scope": "[[concat('Microsoft.Compute/virtualMachines/', parameters('resourceName'))]"
                  }
                ]
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "dcrResourceId": {
                  "value": "[[parameters('dcrResourceId')]"
                },
                "resourceType": {
                  "value": "[[parameters('resourceType')]"
                }
              }
            }
          }
        }
      }
    }
  }
 },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VM.DependencyAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VMs - Dependency Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Deploy Dependency agent for Windows virtual machines with Azure Monitoring Agent settings if the virtual machine image is in the list defined and the agent is not installed.",
    "metadata": {
      "version": "1.2.2",
      "category": "Monitoring"
    },
    "parameters": {
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of virtual machine images that have supported Windows OS to add to scope",
          "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "enableProcessesAndDependencies": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Enable Processes and Dependencies",
          "description": "This is the flag for enabling processes and dependencies data collection in VMInsights. If you are using this standalone policy and what to install Dependency Agent, keep this value as true."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Dependency Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://learn.microsoft.com/en-us/azure/azure-monitor/vm/vminsights-dependency-agent-maintenance"
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "value": "[[parameters('enableProcessesAndDependencies')]",
            "equals": true
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "2008-R2-SP1",
                      "2008-R2-SP1-smalldisk",
                      "2012-Datacenter",
                      "2012-Datacenter-smalldisk",
                      "2012-R2-Datacenter",
                      "2012-R2-Datacenter-smalldisk",
                      "2016-Datacenter",
                      "2016-Datacenter-smalldisk",
                      "2016-Datacenter-with-Containers",
                      "2016-Datacenter-with-RDSH",
                      "2016-datacenter-gensecond",
                      "2019-Datacenter",
                      "2019-Datacenter-smalldisk",
                      "2019-Datacenter-with-Containers",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-gensecond"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-V4"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Windows-10"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "DependencyAgentWindows"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.Monitoring.DependencyAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "DependencyAgentWindows",
                  "vmExtensionPublisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                  "vmExtensionType": "DependencyAgentWindows",
                  "vmExtensionTypeHandlerVersion": "9.10"
                },
                "resources": [
                  {
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "apiVersion": "2021-04-01",
                    "Location": "[[parameters('Location')]",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "enableAMA": "true"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for VM', ': ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VM.LogAnalyticsAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VMs - Log Analytics Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Log Analytics workspace is used to receive performance data. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace",
          "assignPermissions": true
        }
      },
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of virtual machine images that have supported Windows OS to add to scope",
          "description": "Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                "like": "Windows*"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "2008-R2-SP1",
                      "2008-R2-SP1-smalldisk",
                      "2012-Datacenter",
                      "2012-Datacenter-smalldisk",
                      "2012-R2-Datacenter",
                      "2012-R2-Datacenter-smalldisk",
                      "2016-Datacenter",
                      "2016-Datacenter-smalldisk",
                      "2016-Datacenter-with-Containers",
                      "2016-Datacenter-with-RDSH",
                      "2016-datacenter-gensecond",
                      "2019-Datacenter",
                      "2019-Datacenter-smalldisk",
                      "2019-Datacenter-with-Containers",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-gensecond",
                      "2022-datacenter",
                      "2022-datacenter-g2",
                      "2022-datacenter-smalldisk",
                      "2022-datacenter-smalldisk-g2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-V4"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Windows-10"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "MicrosoftMonitoringAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.EnterpriseCloud.Monitoring"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "logAnalytics": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "MicrosoftMonitoringAgent",
                  "vmExtensionPublisher": "Microsoft.EnterpriseCloud.Monitoring",
                  "vmExtensionType": "MicrosoftMonitoringAgent",
                  "vmExtensionTypeHandlerVersion": "1.0"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2018-06-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "workspaceId": "[[reference(parameters('logAnalytics'), '2015-03-20').customerId]",
                        "stopOnMultipleConnections": "true"
                      },
                      "protectedSettings": {
                        "workspaceKey": "[[listKeys(parameters('logAnalytics'), '2015-03-20').primarySharedKey]"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for VM', ': ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VMScaleSet.AzureMonitorAgent.SystemAssignedId",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VM Scale Sets - Azure Monitor Agent - System-assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2008-R2-SP1*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2012-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2016-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2019-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2022-*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          },
          {
            "field": "identity.type",
            "contains": "SystemAssigned"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "AzureMonitorWindowsAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorWindowsAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionType": "AzureMonitorWindowsAgent",
                  "extensionTypeHandlerVersion": "1.1"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VMScaleSet.AzureMonitorAgent.UserAssignedIdentity",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VM Scale Sets - Azure Monitor Agent - User Assigned Identity",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Automate the deployment of Azure Monitor Agent extension on your Windows virtual machine scale sets for collecting telemetry data from the guest OS. This policy will install the extension and configure it to use the specified user-assigned managed identity if the OS and region are supported, and skip install otherwise. Learn more: https://aka.ms/AMAOverview.",
    "metadata": {
      "version": "1.4.0",
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "bringYourOwnUserAssignedManagedIdentity": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Bring Your Own User-Assigned Managed Identity",
          "description": "If set to true, Azure Monitor Agent will use the user-assigned managed identity specified via the 'User-Assigned Managed Identity ...' parameters for authentication. Otherwise, Azure Monitor Agent will use the user-assigned managed identity /subscriptions/<subscription-id>/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-<Location> for authentication."
        },
        "allowedValues": [
          false,
          true
        ]
      },
      "userAssignedManagedIdentityName": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Name",
          "description": "The name of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "userAssignedManagedIdentityResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Resource Group",
          "description": "The resource group of the user-assigned managed identity which Azure Monitor Agent will use for authentication when 'Bring Your Own User-Assigned Managed Identity' is set to true."
        },
        "defaultValue": ""
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2008-R2-SP1*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2012-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2016-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2019-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2022-*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "AzureMonitorWindowsAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "userAssignedManagedIdentity": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorWindowsAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionType": "AzureMonitorWindowsAgent",
                  "extensionTypeHandlerVersion": "1.2"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {
                        "authentication": {
                          "managedIdentity": {
                            "identifier-name": "mi_res_id",
                            "identifier-value": "[[parameters('userAssignedManagedIdentity')]"
                          }
                        }
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "userAssignedManagedIdentity": {
                  "value": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('userAssignedManagedIdentityResourceGroup'), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', parameters('userAssignedManagedIdentityName')), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/built-in-identity-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/built-in-identity-', field('Location')))]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VMScaleSet.DCRa",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VM Scale Set - Data Collection Rule Association",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Copy of existing policy, modified to include \"scope only to supported OS\" parameter",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of virtual machine scale set images that have supported Windows OS to add to scope",
          "description": "Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "dcrResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Resource Id or Data Collection Endpoint Resource Id",
          "description": "Resource Id of the Data Collection Rule or the Data Collection Endpoint to be applied on the Linux machines in scope.",
          "portalReview": "true"
        }
      },
      "resourceType": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Type",
          "description": "Either a Data Collection Rule (DCR) or a Data Collection Endpoint (DCE)",
          "portalReview": "true"
        },
        "allowedValues": [
          "Microsoft.Insights/dataCollectionRules",
          "Microsoft.Insights/dataCollectionEndpoints"
        ],
        "defaultValue": "Microsoft.Insights/dataCollectionRules"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "2008-R2-SP1",
                      "2008-R2-SP1-smalldisk",
                      "2012-Datacenter",
                      "2012-Datacenter-smalldisk",
                      "2012-R2-Datacenter",
                      "2012-R2-Datacenter-smalldisk",
                      "2016-Datacenter",
                      "2016-Datacenter-Server-Core",
                      "2016-Datacenter-Server-Core-smalldisk",
                      "2016-Datacenter-smalldisk",
                      "2016-Datacenter-with-Containers",
                      "2016-Datacenter-with-RDSH",
                      "2016-datacenter-gensecond",
                      "2019-Datacenter",
                      "2019-Datacenter-Core",
                      "2019-Datacenter-Core-smalldisk",
                      "2019-Datacenter-Core-with-Containers",
                      "2019-Datacenter-Core-with-Containers-smalldisk",
                      "2019-Datacenter-smalldisk",
                      "2019-Datacenter-with-Containers",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-gensecond",
                      "2022-datacenter",
                      "2022-datacenter-azure-edition",
                      "2022-datacenter-azure-edition-core",
                      "2022-datacenter-azure-edition-core-smalldisk",
                      "2022-datacenter-azure-edition-smalldisk",
                      "2022-datacenter-core",
                      "2022-datacenter-core-g2",
                      "2022-datacenter-core-smalldisk",
                      "2022-datacenter-core-smalldisk-g2",
                      "2022-datacenter-g2",
                      "2022-datacenter-smalldisk",
                      "2022-datacenter-smalldisk-g2",
                      "2022-datacenter-gensecond"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "evaluationDelay": "AfterProvisioning",
          "existenceCondition": {
            "anyOf": [
              {
                "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionRuleId",
                "equals": "[[parameters('dcrResourceId')]"
              },
              {
                "field": "Microsoft.Insights/dataCollectionRuleAssociations/dataCollectionEndpointId",
                "equals": "[[parameters('dcrResourceId')]"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "dcrResourceId": {
                    "type": "string"
                  },
                  "resourceType": {
                    "type": "string"
                  }
                },
                "variables": {
                  "dcrAssociationName": "[[concat('assoc-', uniqueString(concat(parameters('resourceName'), parameters('dcrResourceId'))))]",
                  "dceAssociationName": "configurationAccessEndpoint",
                  "dcrResourceType": "Microsoft.Insights/dataCollectionRules",
                  "dceResourceType": "Microsoft.Insights/dataCollectionEndpoints"
                },
                "resources": [
                  {
                    "condition": "[[equals(parameters('resourceType'), variables('dcrResourceType'))]",
                    "name": "[[variables('dcrAssociationName')]",
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "dataCollectionRuleId": "[[parameters('dcrResourceId')]"
                    },
                    "scope": "[[concat('Microsoft.Compute/virtualMachineScaleSets/', parameters('resourceName'))]"
                  },
                  {
                    "condition": "[[equals(parameters('resourceType'), variables('dceResourceType'))]",
                    "name": "[[variables('dceAssociationName')]",
                    "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "dataCollectionEndpointId": "[[parameters('dcrResourceId')]"
                    },
                    "scope": "[[concat('Microsoft.Compute/virtualMachineScaleSets/', parameters('resourceName'))]"
                  }
                ]
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "dcrResourceId": {
                  "value": "[[parameters('dcrResourceId')]"
                },
                "resourceType": {
                  "value": "[[parameters('resourceType')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VM.ScaleSet.DependencyAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VM Scale Sets - Dependency Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Deploy Dependency agent for Windows virtual machine scale sets with Azure Monitoring Agent settings if the virtual machine image is in the list defined and the agent is not installed. If your scale set upgradePolicy is set to Manual, you need to apply the extension to all the virtual machines in the set by updating them.",
    "metadata": {
      "version": "1.2.2",
      "category": "Monitoring"
    },
    "parameters": {
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of virtual machine images that have supported Windows OS to add to scope",
          "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "enableProcessesAndDependencies": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Enable Processes and Dependencies",
          "description": "This is the flag for enabling processes and dependencies data collection in VMInsights. If you are using this standalone policy and what to install Dependency Agent, keep this value as true."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Dependency Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale sets resources in the assignment scope. For supported operating systems, see https://learn.microsoft.com/en-us/azure/azure-monitor/vm/vminsights-dependency-agent-maintenance"
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "value": "[[parameters('enableProcessesAndDependencies')]",
            "equals": true
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "2008-R2-SP1",
                      "2008-R2-SP1-smalldisk",
                      "2012-Datacenter",
                      "2012-Datacenter-smalldisk",
                      "2012-R2-Datacenter",
                      "2012-R2-Datacenter-smalldisk",
                      "2016-Datacenter",
                      "2016-Datacenter-smalldisk",
                      "2016-Datacenter-with-Containers",
                      "2016-Datacenter-with-RDSH",
                      "2016-datacenter-gensecond",
                      "2019-Datacenter",
                      "2019-Datacenter-smalldisk",
                      "2019-Datacenter-with-Containers",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-gensecond"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-V4"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Windows-10"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "DependencyAgentWindows"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.Azure.Monitoring.DependencyAgent"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "DependencyAgentWindows",
                  "vmExtensionPublisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                  "vmExtensionType": "DependencyAgentWindows",
                  "vmExtensionTypeHandlerVersion": "9.10"
                },
                "resources": [
                  {
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "apiVersion": "2021-04-01",
                    "Location": "[[parameters('Location')]",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "enableAMA": "true"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for: ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VMScaleSet.LogAnalyticsAgent",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VM Scale Sets - Log Analytics Agent",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Log Analytics workspace is used to receive performance data. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace",
          "assignPermissions": true
        }
      },
      "listOfImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Optional: List of virtual machine images that have supported Windows OS to add to scope",
          "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "2008-R2-SP1",
                      "2008-R2-SP1-smalldisk",
                      "2012-Datacenter",
                      "2012-Datacenter-smalldisk",
                      "2012-R2-Datacenter",
                      "2012-R2-Datacenter-smalldisk",
                      "2016-Datacenter",
                      "2016-Datacenter-smalldisk",
                      "2016-Datacenter-with-Containers",
                      "2016-Datacenter-with-RDSH",
                      "2016-datacenter-gensecond",
                      "2019-Datacenter",
                      "2019-Datacenter-smalldisk",
                      "2019-Datacenter-with-Containers",
                      "2019-Datacenter-with-Containers-smalldisk",
                      "2019-Datacenter-zhcn",
                      "2019-datacenter-gensecond",
                      "2022-datacenter",
                      "2022-datacenter-g2",
                      "2022-datacenter-smalldisk",
                      "2022-datacenter-smalldisk-g2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-V4"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Windows-10"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293",
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "MicrosoftMonitoringAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.EnterpriseCloud.Monitoring"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  },
                  "logAnalytics": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "MicrosoftMonitoringAgent",
                  "vmExtensionPublisher": "Microsoft.EnterpriseCloud.Monitoring",
                  "vmExtensionType": "MicrosoftMonitoringAgent",
                  "vmExtensionTypeHandlerVersion": "1.0"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2018-06-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "workspaceId": "[[reference(parameters('logAnalytics'), '2015-03-20').customerId]",
                        "stopOnMultipleConnections": "true"
                      },
                      "protectedSettings": {
                        "workspaceKey": "[[listKeys(parameters('logAnalytics'), '2015-03-20').primarySharedKey]"
                      }
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat('Enabled extension for: ', parameters('vmName'))]"
                  }
                }
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                },
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                }
              }
            }
          }
        }
      }
    }
  }
  },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VM.ChangeTracking.Extension",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VMs - ChangeTracking Extension",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfLinuxImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfLinuxImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-ARM64",
                      "RHEL-BYOS",
                      "RHEL-HA",
                      "RHEL-SAP",
                      "RHEL-SAP-APPS",
                      "RHEL-SAP-HA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSku",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "UbuntuServer"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-server-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-pro-*"
                      }
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "14.04.0-lts",
                      "14.04.1-lts",
                      "14.04.2-lts",
                      "14.04.3-lts",
                      "14.04.4-lts",
                      "14.04.5-lts",
                      "16_04_0-lts-gen2",
                      "16_04-lts-gen2",
                      "16.04-lts",
                      "16.04.0-lts",
                      "18_04-lts-arm64",
                      "18_04-lts-gen2",
                      "18.04-lts",
                      "20_04-lts-arm64",
                      "20_04-lts-gen2",
                      "20_04-lts",
                      "22_04-lts-gen2",
                      "22_04-lts",
                      "pro-16_04-lts-gen2",
                      "pro-16_04-lts",
                      "pro-18_04-lts-gen2",
                      "pro-18_04-lts",
                      "pro-20_04-lts-gen2",
                      "pro-20_04-lts",
                      "pro-22_04-lts-gen2",
                      "pro-22_04-lts"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "7*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "ctrliqinc1648673227698"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "rocky-8*"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "rocky-8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "Debian"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "equals": "9"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Debian"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian-10",
                      "debian-11"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "10",
                      "10-gen2",
                      "11",
                      "11-gen2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoftcblmariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cbl-mariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "1-gen2",
                      "cbl-mariner-1",
                      "cbl-mariner-2",
                      "cbl-mariner-2-arm64",
                      "cbl-mariner-2-gen2"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "ChangeTracking-Linux"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/Publisher",
                "equals": "Microsoft.Azure.ChangeTrackingAndInventory"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "ChangeTracking-Linux",
                  "vmExtensionPublisher": "Microsoft.Azure.ChangeTrackingAndInventory",
                  "vmExtensionType": "ChangeTracking-Linux",
                  "vmExtensionTypeHandlerVersion": "2.0"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {},
                      "protectedSettings": {}
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Linux.VMScaleSet.ChangeTracking.Extension",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Linux VM Scale Sets - ChangeTracking Extension",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfLinuxImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Linux OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Linux*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfLinuxImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "RedHat"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "RHEL",
                      "RHEL-ARM64",
                      "RHEL-BYOS",
                      "RHEL-HA",
                      "RHEL-SAP",
                      "RHEL-SAP-APPS",
                      "RHEL-SAP-HA"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "rhel-lvm8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "SUSE"
                  },
                  {
                    "anyOf": [
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "SLES",
                              "SLES-HPC",
                              "SLES-HPC-Priority",
                              "SLES-SAP",
                              "SLES-SAP-BYOS",
                              "SLES-Priority",
                              "SLES-BYOS",
                              "SLES-SAPCAL",
                              "SLES-Standard"
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageSku",
                                "like": "15*"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-12*"
                              },
                              {
                                "field": "Microsoft.Compute/imageOffer",
                                "like": "sles-15*"
                              }
                            ]
                          },
                          {
                            "field": "Microsoft.Compute/imageSku",
                            "in": [
                              "gen1",
                              "gen2"
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Canonical"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "UbuntuServer"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-server-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "0001-com-ubuntu-pro-*"
                      }
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "14.04.0-lts",
                      "14.04.1-lts",
                      "14.04.2-lts",
                      "14.04.3-lts",
                      "14.04.4-lts",
                      "14.04.5-lts",
                      "16_04_0-lts-gen2",
                      "16_04-lts-gen2",
                      "16.04-lts",
                      "16.04.0-lts",
                      "18_04-lts-arm64",
                      "18_04-lts-gen2",
                      "18.04-lts",
                      "20_04-lts-arm64",
                      "20_04-lts-gen2",
                      "20_04-lts",
                      "22_04-lts-gen2",
                      "22_04-lts",
                      "pro-16_04-lts-gen2",
                      "pro-16_04-lts",
                      "pro-18_04-lts-gen2",
                      "pro-18_04-lts",
                      "pro-20_04-lts-gen2",
                      "pro-20_04-lts",
                      "pro-22_04-lts-gen2",
                      "pro-22_04-lts"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Oracle"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Oracle-Linux"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "OpenLogic"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "CentOS",
                      "Centos-LVM",
                      "CentOS-SRIOV"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "6*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "7*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "8*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "cloudera"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cloudera-centos-os"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "7*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "almalinux"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "ctrliqinc1648673227698"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "rocky-8*"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "like": "rocky-8*"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "credativ"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "Debian"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "equals": "9"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "Debian"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "debian-10",
                      "debian-11"
                    ]
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "10",
                      "10-gen2",
                      "11",
                      "11-gen2"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoftcblmariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "cbl-mariner"
                  },
                  {
                    "field": "Microsoft.Compute/imageSku",
                    "in": [
                      "1-gen2",
                      "cbl-mariner-1",
                      "cbl-mariner-2",
                      "cbl-mariner-2-arm64",
                      "cbl-mariner-2-gen2"
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "ChangeTracking-Linux"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                "equals": "Microsoft.Azure.ChangeTrackingAndInventory"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "ChangeTracking-Linux",
                  "vmExtensionPublisher": "Microsoft.Azure.ChangeTrackingAndInventory",
                  "vmExtensionType": "ChangeTracking-Linux",
                  "vmExtensionTypeHandlerVersion": "2.0"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-03-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {},
                      "protectedSettings": {}
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VM.ChangeTracking.Extension",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VMs - ChangeTracking Extension",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Configure Windows virtual machines to automatically install the ChangeTracking Extension.",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machines with supported operating systems. Otherwise, the policy will apply to all virtual machine resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2008-R2-SP1*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2012-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2016-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2019-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2022-*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "ChangeTracking-Windows"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/Publisher",
                "equals": "Microsoft.Azure.ChangeTrackingAndInventory"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "ChangeTracking-Windows",
                  "vmExtensionPublisher": "Microsoft.Azure.ChangeTrackingAndInventory",
                  "vmExtensionType": "ChangeTracking-Windows",
                  "vmExtensionTypeHandlerVersion": "2.0"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-07-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {},
                      "protectedSettings": {}
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
{
            "type": "Microsoft.Authorization/policyDefinitions",
            "name": "AzMon.Windows.VMScaleSet.ChangeTracking.Extension",
            "apiVersion": "2019-09-01",
            "properties": {
    "displayName": "Azure Monitor: Windows VM Scale Sets - ChangeTracking Extension",
    "policyType": "Custom",
    "mode": "Indexed",
    "metadata": {
      "category": "Monitoring"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "scopeToSupportedImages": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Scope Policy to Azure Monitor Agent-Supported Operating Systems",
          "description": "If set to true, the policy will apply only to virtual machine scale sets with supported operating systems. Otherwise, the policy will apply to all virtual machine scale set resources in the assignment scope. For supported operating systems, see https://aka.ms/AMAOverview."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": true
      },
      "listOfWindowsImageIdToInclude": {
        "type": "Array",
        "metadata": {
          "displayName": "Additional Virtual Machine Images",
          "description": "List of virtual machine images that have supported Windows OS to add to scope. Example values: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachineScaleSets"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[parameters('scopeToSupportedImages')]",
                    "equals": false
                  },
                  {
                    "field": "Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.osType",
                    "like": "Windows*"
                  }
                ]
              },
              {
                "field": "Microsoft.Compute/imageId",
                "in": "[[parameters('listOfWindowsImageIdToInclude')]"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2008-R2-SP1*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2012-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2016-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2019-*"
                      },
                      {
                        "field": "Microsoft.Compute/imageSku",
                        "like": "2022-*"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerSemiAnnual"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "in": [
                      "Datacenter-Core-1709-smalldisk",
                      "Datacenter-Core-1709-with-Containers-smalldisk",
                      "Datacenter-Core-1803-with-Containers-smalldisk"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsServerHPCPack"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "WindowsServerHPCPack"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftSQLServer"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2022-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2019-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2016-BYOL"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "*-WS2012R2-BYOL"
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftRServer"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "MLServer-WS2016"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftVisualStudio"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "in": [
                      "VisualStudio",
                      "Windows"
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftDynamicsAX"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "Dynamics"
                  },
                  {
                    "field": "Microsoft.Compute/imageSKU",
                    "equals": "Pre-Req-AX7-Onebox-U8"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "microsoft-ads"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "equals": "windows-data-science-vm"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "equals": "MicrosoftWindowsDesktop"
                  },
                  {
                    "field": "Microsoft.Compute/imageOffer",
                    "like": "Windows-1*"
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                "equals": "ChangeTracking-Windows"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/Publisher",
                "equals": "Microsoft.Azure.ChangeTrackingAndInventory"
              },
              {
                "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/provisioningState",
                "equals": "Succeeded"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "Location": {
                    "type": "string"
                  }
                },
                "variables": {
                  "vmExtensionName": "ChangeTracking-Windows",
                  "vmExtensionPublisher": "Microsoft.Azure.ChangeTrackingAndInventory",
                  "vmExtensionType": "ChangeTracking-Windows",
                  "vmExtensionTypeHandlerVersion": "2.0"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                    "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                    "Location": "[[parameters('Location')]",
                    "apiVersion": "2019-03-01",
                    "properties": {
                      "publisher": "[[variables('vmExtensionPublisher')]",
                      "type": "[[variables('vmExtensionType')]",
                      "typeHandlerVersion": "[[variables('vmExtensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {},
                      "protectedSettings": {}
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "Location": {
                  "value": "[[field('Location')]"
                }
              }
            }
          }
        }
      }
    }
  }
        },
        {
            "type": "Microsoft.Authorization/policySetDefinitions",
            "name": "AzMon.VMI.ChangeTracking",
            "apiVersion": "2019-09-01",
            "dependsOn": [
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VM.ScaleSet.DependencyAgent')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VM.DependencyAgent')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VM.DependencyAgent')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VMScaleSet.DependencyAgent')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VM.DCRa')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VM.DCRa')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VMScaleSet.DCRa')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VMScaleSet.DCRa')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VMScaleSet.AzureMonitorAgent.SystemAssignedId')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VM.AzureMonitorAgent.SystemAssignedIdentity')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VM.AzureMonitorAgent.SystemAssignedIdentity')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VMScaleSet.AzureMonitorAgent.SystemAssignedIdentity')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VMScaleSet.ChangeTracking.Extension')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VM.ChangeTracking.Extension')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VM.ChangeTracking.Extension')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VMScaleSet.ChangeTracking.Extension')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VMScaleSet.DCRa')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VMScaleSet.DCRa')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Windows.VM.DCRa')]",
                            "[resourceId('Microsoft.Authorization/policyDefinitions', 'AzMon.Linux.VM.DCRa')]"
                          ],
            "Properties": {
                "Description": "",
                "DisplayName": "Azure Monitor: VM Insights and Change Tracking Configuration",
                "Metadata": {
                    "category": "Monitoring"
                },
                "Parameters": {
                    "Effect": {
                        "type": "string",
                        "metadata": {
                            "displayName": "Effect",
                            "description": null
                        },
                        "allowedValues": [
                            "DeployIfNotExists",
                            "Disabled"
                        ],
                        "defaultValue": "DeployIfNotExists"
                    },
                    "VM Insights DCR": {
                        "type": "string",
                        "metadata": {
                            "displayName": "VM Insights DCR",
                            "description": null
                        },
                        "defaultValue": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.Insights/dataCollectionRules/', 'MSVMI-DCR')]"
                    },
                    "Additional Linux VM Images": {
                        "type": "array",
                        "metadata": {
                            "displayName": "Additional Linux VM Images",
                            "description": null
                        },
                        "defaultValue": []
                    },
                    "Additional Windows VM Images": {
                        "type": "array",
                        "metadata": {
                            "displayName": "Additional Windows VM Images",
                            "description": null
                        },
                        "defaultValue": []
                    },
                    "Scope Windows VMs to supported OS": {
                        "type": "boolean",
                        "metadata": {
                            "displayName": "Scope Windows VMs to supported OS",
                            "description": null
                        },
                        "defaultValue": true
                    },
                    "Scope Linux VMs to supported OS": {
                        "type": "boolean",
                        "metadata": {
                            "displayName": "Scope Linux VMs to supported OS",
                            "description": null
                        },
                        "defaultValue": true
                    },
                    "Scope Linux VM Scale Sets to supported OS": {
                        "type": "boolean",
                        "metadata": {
                            "displayName": "Scope Linux VM Scale Sets to supported OS",
                            "description": null
                        },
                        "defaultValue": true
                    },
                    "Scope Windows VM Scale Sets to supported OS": {
                        "type": "boolean",
                        "metadata": {
                            "displayName": "Scope Windows VM Scale Sets to supported OS",
                            "description": null
                        },
                        "defaultValue": true
                    },
                    "Change Tracking DCR": {
                        "type": "string",
                        "metadata": {
                            "displayName": "Change Tracking DCR"
                        },
                        "defaultValue": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.Insights/dataCollectionRules/', 'ChangeTracking-DCR')]"
                    }
                },
                "PolicyDefinitionGroups": [
                    {
                        "name": "Windows VM",
                        "displayName": "Windows VM"
                    },
                    {
                        "name": "Linux VM",
                        "displayName": "Linux VM"
                    },
                    {
                        "name": "Windows VM Scale Set",
                        "displayName": "Windows VM Scale Set"
                    },
                    {
                        "name": "Linux VM Scale Set",
                        "displayName": "Linux VM Scale Set"
                    }
                ],
                "PolicyDefinitions": [
                    {
                        "policyDefinitionReferenceId": "Windows VM Scale Set - Dependency Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VM.ScaleSet.DependencyAgent')]",
                        "parameters": {
                            "listOfImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            },
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VM Scale Sets to supported OS')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM - Dependency Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VM.DependencyAgent')]",
                        "parameters": {
                            "listOfImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            },
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VMs to supported OS')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM - Dependency Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VM.DependencyAgent')]",
                        "parameters": {
                            "listOfImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            },
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VMs to supported OS')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM Scale Set - Dependency Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VMScaleSet.DependencyAgent')]",
                        "parameters": {
                            "listOfImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            },
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VM Scale Sets to supported OS')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM - VM Insights Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VM.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VMs to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('VM Insights DCR')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM - VM Insights Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VM.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VMs to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('VM Insights DCR')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM Scale Set - VM Insights Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VMScaleSet.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VM Scale Sets to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('VM Insights DCR')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM Scale Set - VM Insights Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VMScaleSet.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VM Scale Sets to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('VM Insights DCR')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM Scale Set - Azure Monitor Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VMScaleSet.AzureMonitorAgent.SystemAssignedId')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VM Scale Sets to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM - Azure Monitor Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VM.AzureMonitorAgent.SystemAssignedIdentity')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VMs to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM - Azure Monitor Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VM.AzureMonitorAgent.SystemAssignedIdentity')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VMs to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM Scale Set - Azure Monitor Agent",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VMScaleSet.AzureMonitorAgent.SystemAssignedIdentity')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VM Scale Sets to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM Scale Set - Change Tracking Extension",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VMScaleSet.ChangeTracking.Extension')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VM Scale Sets to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM - Change Tracking Extension",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VM.ChangeTracking.Extension')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VMs to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM - Change Tracking Extension",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VM.ChangeTracking.Extension')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VMs to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM Scale Set - Change Tracking Extension",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VMScaleSet.ChangeTracking.Extension')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VM Scale Sets to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM Scale Set - Change Tracking Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VMScaleSet.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VM Scale Sets to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('Change Tracking DCR')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM Scale Set - Change Tracking Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VMScaleSet.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VM Scale Sets to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('Change Tracking DCR')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM Scale Set"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Windows VM - Change Tracking Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Windows.VM.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Windows VMs to supported OS')]"
                            },
                            "listOfWindowsImageIdToInclude": {
                                "value": "[[parameters('Additional Windows VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('Change Tracking DCR')]"
                            }
                        },
                        "groupNames": [
                            "Windows VM"
                        ]
                    },
                    {
                        "policyDefinitionReferenceId": "Linux VM - Change Tracking Data Collection Rule",
                        "policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/AzMon.Linux.VM.DCRa')]",
                        "parameters": {
                            "effect": {
                                "value": "[[parameters('Effect')]"
                            },
                            "scopeToSupportedImages": {
                                "value": "[[parameters('Scope Linux VMs to supported OS')]"
                            },
                            "listOfLinuxImageIdToInclude": {
                                "value": "[[parameters('Additional Linux VM Images')]"
                            },
                            "dcrResourceId": {
                                "value": "[[parameters('Change Tracking DCR')]"
                            }
                        },
                        "groupNames": [
                            "Linux VM"
                        ]
                    }
                ],
                "PolicyType": "Custom"
            }
        }
    ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  }
}